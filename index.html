<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الاختبارات المعملية للتربة | ASTM Standards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }

        .tab-active {
            background-color: white;
            border-top: 4px solid #2563eb;
            color: #2563eb;
        }

        .tab-inactive {
            background-color: #f9fafb;
            color: #6b7280;
            border-top: 4px solid transparent;
        }

        .input-field {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .calc-val {
            background-color: #f9fafb;
            font-weight: 600;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            .container { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 10mm !important; }
            .shadow-lg, .rounded-xl { box-shadow: none !important; border: 1px solid #eee !important; }
            .tab-content { display: block !important; }
            section { display: block !important; page-break-before: always; }
            #tab-d1557, #tab-d4318 { display: block !important; }
            .chart-container { page-break-inside: avoid; }
            table { font-size: 9pt; }
            h1, h2, h3 { color: black !important; }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Specific Table Styling */
        th { font-size: 0.75rem; white-space: nowrap; }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white py-6 no-print shadow-md">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">منصة الاختبارات المعملية للتربة</h1>
                <p class="text-slate-400 text-sm mt-1 uppercase tracking-wider">Engineering Soil Testing Platform</p>
                <p class="text-blue-400 text-sm mt-2 font-semibold">إعداد وتطوير: محمد القصبي</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-lg">
                    <span>تصدير تقرير PDF</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="container mx-auto px-4 mt-6 no-print">
        <div class="flex flex-wrap gap-1">
            <button onclick="showTab('d6913')" id="btn-d6913" class="px-8 py-3 font-bold rounded-t-lg transition tab-active">التدرج الحبيبي (D6913)</button>
            <button onclick="showTab('d1557')" id="btn-d1557" class="px-8 py-3 font-bold rounded-t-lg transition tab-inactive">الدمك (D1557)</button>
            <button onclick="showTab('d4318')" id="btn-d4318" class="px-8 py-3 font-bold rounded-t-lg transition tab-inactive">الحدود (D4318)</button>
        </div>
    </nav>

    <main class="container mx-auto px-4 pb-12">

        <!-- SECTION: ASTM D6913 - Gradation -->
        <section id="tab-d6913" class="bg-white rounded-b-xl rounded-tl-xl shadow-xl overflow-hidden animate-fadeIn">
            <div class="p-6 md:p-8">
                <div class="flex flex-col md:row justify-between items-start gap-4 mb-8 border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-700">تحليل التدرج الحبيبي (Sieve Analysis)</h2>
                        <p class="text-gray-500 text-sm">ASTM D6913/D6913M - Particle-Size Distribution of Soils</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-6 no-print">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-semibold text-gray-600">طريقة الاختبار:</span>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" name="d6913-method" value="single" checked onchange="toggleD6913Method()">
                                    <span class="text-sm">Single-Set</span>
                                </label>
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" name="d6913-method" value="composite" onchange="toggleD6913Method()">
                                    <span class="text-sm">Composite</span>
                                </label>
                            </div>
                        </div>
                        <div id="d6913-separator-container" class="hidden items-center gap-2">
                            <span class="text-sm font-semibold text-gray-600">منخل الفصل:</span>
                            <select id="d6913-separator" onchange="initD6913Tables()" class="bg-blue-50 border border-blue-200 text-blue-800 px-2 py-1 rounded-md text-sm outline-none">
                                <option value="19.0">3/4 in (19.0 mm)</option>
                                <option value="9.5">3/8 in (9.5 mm)</option>
                                <option value="4.75" selected>No.4 (4.75 mm)</option>
                                <option value="2.0">No.10 (2.0 mm)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">رقم العينة (Sample ID)</label>
                        <input type="text" id="d6913-sample-id" class="input-field" placeholder="G-101">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">الوزن الجاف الكلي (S,Md)</label>
                        <input type="number" id="d6913-smd" class="input-field border-blue-200" placeholder="g">
                    </div>
                    <div id="d6913-composite-inputs" class="hidden md:col-span-2 grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">وزن الجزء الناعم الرطب</label>
                            <input type="number" id="d6913-fpm" class="input-field" placeholder="FP,Mm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">محتوى الماء % (wfp)</label>
                            <input type="number" id="d6913-wfp" class="input-field" placeholder="%">
                        </div>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- Single Set / Coarse Table -->
                    <div>
                        <h3 id="d6913-table-1-title" class="text-lg font-bold text-gray-700 mb-4">جدول المناخل</h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="w-full text-center text-sm">
                                <thead class="bg-gray-50 text-gray-500 font-bold">
                                    <tr>
                                        <th class="p-2 border">Sieve</th>
                                        <th class="p-2 border">Opening (mm)</th>
                                        <th class="p-2 border">CMRN (g)</th>
                                        <th class="p-2 border bg-blue-50 text-blue-700">% Passing</th>
                                    </tr>
                                </thead>
                                <tbody id="d6913-table-1-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Fine Subspecimen Table (for Composite) -->
                    <div id="d6913-fine-container" class="hidden">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">الجزء الناعم (Subspecimen)</h3>
                        <div class="p-3 bg-gray-50 border rounded mb-4 text-xs">
                            <label class="font-bold">وزن العينة الفرعية الجافة (SubS,Md):</label>
                            <input type="number" id="d6913-sub-smd" class="input-field mt-1" placeholder="g">
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="w-full text-center text-sm">
                                <thead class="bg-gray-50 text-gray-500 font-bold">
                                    <tr>
                                        <th class="p-2 border">Sieve</th>
                                        <th class="p-2 border">SubS CMRN (g)</th>
                                        <th class="p-2 border bg-indigo-50 text-indigo-700">Specimen %Passing</th>
                                    </tr>
                                </thead>
                                <tbody id="d6913-table-2-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Results & Graph -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-12">
                    <div class="lg:col-span-1 space-y-4">
                        <div id="d6913-results-card" class="bg-blue-700 text-white p-6 rounded-2xl shadow-lg hidden">
                            <h4 class="font-bold text-center mb-4">النتائج الهندسية</h4>
                            <div class="grid grid-cols-2 gap-2 text-center text-xs">
                                <div class="bg-white/10 p-2 rounded"><span>D60:</span> <b id="d6913-d60">--</b></div>
                                <div class="bg-white/10 p-2 rounded"><span>D30:</span> <b id="d6913-d30">--</b></div>
                                <div class="bg-white/10 p-2 rounded"><span>D10:</span> <b id="d6913-d10">--</b></div>
                                <div class="bg-white/10 p-2 rounded"><span>Cu:</span> <b id="d6913-cu">--</b></div>
                                <div class="bg-white/10 p-2 rounded"><span>Cc:</span> <b id="d6913-cc">--</b></div>
                                <div class="bg-white/10 p-2 rounded"><span>Pan:</span> <b id="d6913-pan-final">--</b>%</div>
                            </div>
                        </div>
                        <button onclick="calculateD6913()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">احسب التدرج</button>
                        <button onclick="loadD6913Example()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded-xl transition text-sm">تحميل مثال</button>
                        <button onclick="resetD6913()" class="w-full text-red-500 font-bold py-2 text-sm">مسح البيانات</button>
                    </div>
                    <div class="lg:col-span-2 bg-white p-4 rounded-2xl border border-gray-100 h-[450px]">
                        <canvas id="d6913-chart"></canvas>
                    </div>
                </div>

                <!-- Final Specimen Gradation Table -->
                <div id="d6913-final-table-container" class="mt-12 hidden">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">التدرج النهائي للعينة (Specimen Gradation)</h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-center text-sm">
                            <thead class="bg-gray-800 text-white font-bold">
                                <tr>
                                    <th class="p-3 border">Sieve</th>
                                    <th class="p-3 border">Opening (mm)</th>
                                    <th class="p-3 border">% Passing</th>
                                    <th class="p-3 border">Cum % Retained</th>
                                    <th class="p-3 border">% Retained</th>
                                </tr>
                            </thead>
                            <tbody id="d6913-final-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- SECTION: ASTM D1557 - Modified Proctor -->
        <section id="tab-d1557" class="hidden bg-white rounded-b-xl rounded-tl-xl shadow-xl overflow-hidden animate-fadeIn">
            <div class="p-6 md:p-8">
                <!-- Title & Meta -->
                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-8 border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-emerald-700">اختبار الدمك المعدل (Modified Proctor)</h2>
                        <p class="text-gray-500 text-sm">ASTM D1557 / D1557M - Compaction Characteristics of Soil</p>
                    </div>
                    <div class="flex items-center gap-3 no-print">
                        <span class="text-sm font-semibold text-gray-600">نظام الوحدات:</span>
                        <select id="proctor-unit-system" onchange="calculateProctor()" class="bg-emerald-50 border border-emerald-200 text-emerald-800 px-3 py-1 rounded-md font-bold outline-none ring-emerald-300">
                            <option value="g_cm3">g/cm³</option>
                            <option value="kg_m3">kg/m³</option>
                            <option value="kN_m3">kN/m³</option>
                        </select>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">رقم العينة (Sample ID)</label>
                        <input type="text" id="proctor-sample-id" class="input-field" placeholder="P-001">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">تاريخ الاختبار</label>
                        <input type="date" id="proctor-date" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">الطريقة (Method)</label>
                        <select id="proctor-method" class="input-field">
                            <option value="A">Method A</option>
                            <option value="B">Method B</option>
                            <option value="C" selected>Method C</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">الثقل النوعي (Gs)</label>
                        <input type="number" id="proctor-gs" class="input-field" value="2.65" step="0.01" oninput="calculateProctor()">
                    </div>
                </div>

                <!-- Mold Properties -->
                <div class="p-5 rounded-lg bg-emerald-50 border border-emerald-100 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-emerald-900 mb-2">وزن القالب الفارغ (g)</label>
                        <input type="number" id="proctor-mold-mass" class="input-field border-emerald-200" placeholder="مثلاً 4250" oninput="calculateProctor()">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-emerald-900 mb-2">حجم القالب</label>
                        <div class="flex">
                            <input type="number" id="proctor-mold-vol" class="input-field border-emerald-200 rounded-l-none" placeholder="مثلاً 944" oninput="calculateProctor()">
                            <select id="proctor-mold-vol-unit" onchange="calculateProctor()" class="bg-white border border-emerald-200 border-r-0 rounded-l-md px-2 text-sm font-semibold outline-none">
                                <option value="cm3">cm³</option>
                                <option value="m3">m³</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center justify-center pt-6 no-print">
                        <button onclick="loadProctorExample()" class="text-sm font-bold text-emerald-600 hover:text-emerald-800 underline transition">تحميل مثال</button>
                    </div>
                </div>

                <!-- Table 1: Water Content -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
                        1. جدول محتوى الماء (Water Content)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-center">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border">#</th>
                                    <th class="p-3 border">Wet + Tare (g)</th>
                                    <th class="p-3 border">Dry + Tare (g)</th>
                                    <th class="p-3 border">Tare (g)</th>
                                    <th class="p-3 border bg-emerald-50 text-emerald-600">Water (g)</th>
                                    <th class="p-3 border bg-emerald-50 text-emerald-600">Dry Soil (g)</th>
                                    <th class="p-3 border bg-emerald-100 text-emerald-900">w (%)</th>
                                </tr>
                            </thead>
                            <tbody id="proctor-wc-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Table 2: Density -->
                <div class="mb-10">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
                        2. بيانات الدمك (Density Data)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-center">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border">#</th>
                                    <th class="p-3 border">القالب + التربة الرطبة (g)</th>
                                    <th class="p-3 border bg-emerald-50 text-emerald-600" id="proctor-moist-label">الكثافة الرطبة</th>
                                    <th class="p-3 border bg-emerald-100 text-emerald-900 font-black" id="proctor-dry-label">الكثافة الجافة</th>
                                </tr>
                            </thead>
                            <tbody id="proctor-density-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary & Graph -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12 items-start">
                    <div id="proctor-results-container" class="hidden">
                        <div class="bg-emerald-600 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
                            <h4 class="text-center font-bold text-xl mb-6 tracking-wide">النتائج النهائية (Final Results)</h4>
                            <div class="grid grid-cols-2 gap-6">
                                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 text-center border border-white/20">
                                    <span class="block text-[10px] uppercase opacity-80 mb-1 font-bold">Optimum Moisture (OMC)</span>
                                    <span id="proctor-res-omc" class="text-4xl font-black">--</span>
                                    <span class="text-lg font-bold">%</span>
                                </div>
                                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-5 text-center border border-white/20">
                                    <span class="block text-[10px] uppercase opacity-80 mb-1 font-bold">Max Dry Density (MDD)</span>
                                    <span id="proctor-res-mdd" class="text-4xl font-black">--</span>
                                    <span id="proctor-res-unit" class="block text-[10px] mt-2 font-black opacity-90">--</span>
                                </div>
                            </div>
                            <div class="mt-8 pt-4 border-t border-white/20">
                                <p class="text-[10px] uppercase opacity-60 mb-2 font-bold">التحويلات البديلة (Alternate Units):</p>
                                <p id="proctor-res-alt" class="text-xs font-semibold tracking-wider">--</p>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2 no-print">
                            <button onclick="calculateProctor()" class="flex-1 bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-4 rounded-xl shadow-lg transition duration-200">إعادة حساب</button>
                            <button onclick="resetProctor()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-xl font-bold transition">مسح الكل</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-inner border border-gray-100 h-[450px]">
                        <canvas id="proctor-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: ASTM D4318 - Atterberg Limits -->
        <section id="tab-d4318" class="hidden bg-white rounded-b-xl rounded-tl-xl shadow-xl overflow-hidden animate-fadeIn">
            <div class="p-6 md:p-8">
                <!-- Title & Meta -->
                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-8 border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-700">حدود أتربرج (Atterberg Limits)</h2>
                        <p class="text-gray-500 text-sm">ASTM D4318 - Liquid Limit, Plastic Limit, and Plasticity Index</p>
                    </div>
                </div>

                <!-- Basic Info & Method Selection -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 items-end">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">رقم العينة (Sample ID)</label>
                        <input type="text" id="atterberg-sample-id" class="input-field" placeholder="A-101">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">تاريخ الاختبار</label>
                        <input type="date" id="atterberg-date" class="input-field">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase">طريقة الاختبار (Method)</label>
                        <div class="flex gap-4 p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="d4318-method" value="A" checked onchange="toggleD4318Method()" class="w-4 h-4 text-indigo-600">
                                <span class="text-xs font-bold text-indigo-900">Method A (Multipoint)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="d4318-method" value="B" onchange="toggleD4318Method()" class="w-4 h-4 text-indigo-600">
                                <span class="text-xs font-bold text-indigo-900">Method B (One-point)</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex items-center justify-end no-print md:col-start-4">
                        <button onclick="loadAtterbergExample()" class="text-sm font-bold text-indigo-600 hover:text-indigo-800 underline transition">تحميل مثال</button>
                    </div>
                </div>

                <!-- Liquid Limit Table -->
                <div class="mb-12">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span>
                        1. حد السيولة (Liquid Limit - LL)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-center">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border">#</th>
                                    <th class="p-3 border">عدد الضربات (N)</th>
                                    <th class="p-3 border">Wet + Tare (g)</th>
                                    <th class="p-3 border">Dry + Tare (g)</th>
                                    <th class="p-3 border">Tare (g)</th>
                                    <th class="p-3 border bg-indigo-50 text-indigo-700">Water (g)</th>
                                    <th class="p-3 border bg-indigo-50 text-indigo-700">Dry Soil (g)</th>
                                    <th class="p-3 border bg-indigo-100 text-indigo-900 font-black">w (%)</th>
                                </tr>
                            </thead>
                            <tbody id="atterberg-ll-tbody"></tbody>
                        </table>
                    </div>
                    <p id="d4318-note" class="text-[9px] text-gray-400 mt-2 font-bold tracking-tight">* ملاحظة (Method A): يجب أن تكون قيم الضربات موزعة بين (15-35) ضربة (نطاقات 25-35, 20-30, 15-25).</p>
                </div>

                <!-- Plastic Limit Table -->
                <div class="mb-12">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span>
                        2. حد اللدونة (Plastic Limit - PL)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 max-w-5xl">
                        <table class="w-full text-center">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase">
                                <tr>
                                    <th class="p-3 border">#</th>
                                    <th class="p-3 border">Wet + Tare (g)</th>
                                    <th class="p-3 border">Dry + Tare (g)</th>
                                    <th class="p-3 border">Tare (g)</th>
                                    <th class="p-3 border bg-indigo-50 text-indigo-700">Water (g)</th>
                                    <th class="p-3 border bg-indigo-50 text-indigo-700">Dry Soil (g)</th>
                                    <th class="p-3 border bg-indigo-100 text-indigo-900 font-black">w (%)</th>
                                </tr>
                            </thead>
                            <tbody id="atterberg-pl-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary & Graph -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12 items-start">
                    <div id="atterberg-results-container" class="hidden">
                        <div class="bg-indigo-700 rounded-2xl p-8 text-white shadow-xl border-b-8 border-indigo-900">
                            <h4 class="text-center font-bold text-xl mb-6 tracking-wide">نتائج الحدود (Final Atterberg)</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white/10 rounded-2xl p-4 text-center border border-white/20">
                                    <span class="block text-[10px] opacity-80 mb-1 font-bold">Liquid Limit</span>
                                    <span id="atterberg-res-ll" class="text-3xl font-black">--</span>
                                    <span class="text-sm font-bold">%</span>
                                </div>
                                <div class="bg-white/10 rounded-2xl p-4 text-center border border-white/20">
                                    <span class="block text-[10px] opacity-80 mb-1 font-bold">Plastic Limit</span>
                                    <span id="atterberg-res-pl" class="text-3xl font-black">--</span>
                                    <span class="text-sm font-bold">%</span>
                                </div>
                                <div class="bg-white/10 rounded-2xl p-4 text-center border border-white/20">
                                    <span class="block text-[10px] opacity-80 mb-1 font-bold">Plasticity Index</span>
                                    <span id="atterberg-res-pi" class="text-3xl font-black">--</span>
                                    <span class="text-sm font-bold">%</span>
                                </div>
                            </div>
                            <div id="atterberg-state-badge" class="mt-8 py-3 px-4 bg-white/20 rounded-xl text-center font-bold text-sm border border-white/10">
                                الحالة: --
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2 no-print">
                            <button onclick="calculateAtterberg()" class="flex-1 bg-indigo-800 hover:bg-indigo-900 text-white font-bold py-4 rounded-xl shadow-lg transition">تحديث الحساب</button>
                            <button onclick="resetAtterberg()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-xl font-bold transition">مسح</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-inner border border-gray-100 h-[450px]">
                        <canvas id="atterberg-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-500 py-12 no-print mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm font-bold">© 2025 منصة القصبى للهندسة — جميع الحقوق محفوظة</p>
            <p class="text-[9px] mt-4 uppercase tracking-[0.2em] opacity-50">Prepared and Developed by Mohamed El-Kasaby</p>

        </div>
    </footer>

    <script>
        // GLOBAL CHART INSTANCES
        let proctorChartInstance = null;
        let atterbergChartInstance = null;
        let d6913ChartInstance = null;

        const SIEVES = [
            { name: '3 in', opening: 75.0 },
            { name: '2 in', opening: 50.0 },
            { name: '1.5 in', opening: 37.5 },
            { name: '1 in', opening: 25.0 },
            { name: '3/4 in', opening: 19.0 },
            { name: '3/8 in', opening: 9.5 },
            { name: 'No.4', opening: 4.75 },
            { name: 'No.10', opening: 2.0 },
            { name: 'No.20', opening: 0.850 },
            { name: 'No.40', opening: 0.425 },
            { name: 'No.60', opening: 0.250 },
            { name: 'No.100', opening: 0.150 },
            { name: 'No.140', opening: 0.106 },
            { name: 'No.200', opening: 0.075 }
        ];

        // INITIALIZATION
        window.addEventListener('DOMContentLoaded', () => {
            initD6913Tables();
            initProctorTables();
            initAtterbergTables();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('proctor-date').value = today;
            document.getElementById('atterberg-date').value = today;
        });

        // UI HELPERS
        function showTab(tabId) {
            ['d6913', 'd1557', 'd4318'].forEach(id => {
                document.getElementById('tab-' + id).classList.add('hidden');
                document.getElementById('btn-' + id).classList.remove('tab-active');
                document.getElementById('btn-' + id).classList.add('tab-inactive');
            });
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('tab-active');
            document.getElementById('btn-' + tabId).classList.remove('tab-inactive');
        }

        // --- ASTM D6913 GRADATION ---
        function initD6913Tables() {
            const method = document.querySelector('input[name="d6913-method"]:checked').value;
            const sepOpening = parseFloat(document.getElementById('d6913-separator').value);
            
            const table1 = document.getElementById('d6913-table-1-body');
            const table2 = document.getElementById('d6913-table-2-body');
            if (!table1 || !table2) return;
            table1.innerHTML = '';
            table2.innerHTML = '';

            const coarseSieves = (method === 'composite') ? SIEVES.filter(s => s.opening >= sepOpening) : SIEVES;
            coarseSieves.forEach((s, idx) => {
                const isSep = s.opening === sepOpening;
                table1.innerHTML += `
                    <tr class="${isSep && method === 'composite' ? 'bg-blue-50' : ''}">
                        <td class="p-2 border font-bold">${s.name}</td>
                        <td class="p-2 border text-gray-400">${s.opening}</td>
                        <td class="p-1 border"><input type="number" step="0.1" class="input-field d6913-cmrn-1" data-opening="${s.opening}" data-name="${s.name}"></td>
                        <td class="p-2 border calc-val d6913-pp-1">--</td>
                    </tr>
                `;
            });
            if (method !== 'composite') {
                table1.innerHTML += `<tr><td class="p-2 border font-bold">Pan</td><td class="p-2 border">--</td><td class="p-1 border"><input type="number" step="0.1" class="input-field d6913-pan-1"></td><td class="p-2 border">--</td></tr>`;
            }

            if (method === 'composite') {
                const fineSieves = SIEVES.filter(s => s.opening <= sepOpening);
                fineSieves.forEach((s, idx) => {
                    const isSep = s.opening === sepOpening;
                    table2.innerHTML += `
                        <tr class="${isSep ? 'bg-indigo-50' : ''}">
                            <td class="p-2 border font-bold">${s.name}</td>
                            <td class="p-1 border"><input type="number" step="0.1" class="input-field d6913-cmrn-2" data-opening="${s.opening}" data-name="${s.name}"></td>
                            <td class="p-2 border calc-val d6913-pp-2">--</td>
                        </tr>
                    `;
                });
                table2.innerHTML += `<tr><td class="p-2 border font-bold">Pan</td><td class="p-1 border"><input type="number" step="0.1" class="input-field d6913-pan-2"></td><td class="p-2 border">--</td></tr>`;
            }
        }

        function toggleD6913Method() {
            const method = document.querySelector('input[name="d6913-method"]:checked').value;
            const compInputs = document.getElementById('d6913-composite-inputs');
            const fineCont = document.getElementById('d6913-fine-container');
            const table1Title = document.getElementById('d6913-table-1-title');
            const smdInput = document.getElementById('d6913-smd');
            const sepCont = document.getElementById('d6913-separator-container');

            if (method === 'composite') {
                compInputs.classList.remove('hidden');
                fineCont.classList.remove('hidden');
                sepCont.classList.remove('hidden');
                sepCont.classList.add('flex');
                table1Title.innerText = "الجزء الخشن (Coarser Portion)";
                smdInput.placeholder = "CP,Md (Dry mass)";
            } else {
                compInputs.classList.add('hidden');
                fineCont.classList.add('hidden');
                sepCont.classList.add('hidden');
                sepCont.classList.remove('flex');
                table1Title.innerText = "جدول المناخل";
                smdInput.placeholder = "S,Md (Dry mass)";
            }
            initD6913Tables();
        }

        function calculateD6913() {
            const method = document.querySelector('input[name="d6913-method"]:checked').value;
            const sepOpening = parseFloat(document.getElementById('d6913-separator').value);
            let smdInputVal = parseFloat(document.getElementById('d6913-smd').value) || 0;
            
            const cmrn1 = document.querySelectorAll('.d6913-cmrn-1');
            const pp1Display = document.querySelectorAll('.d6913-pp-1');

            let finalPoints = [];

            if (method === 'single') {
                if (smdInputVal <= 0) return alert("يرجى إدخال وزن العينة الجاف");
                cmrn1.forEach((inp, i) => {
                    const v = parseFloat(inp.value);
                    const opening = parseFloat(inp.dataset.opening);
                    if (!isNaN(v)) {
                        const pp = 100 * (1 - v / smdInputVal);
                        pp1Display[i].innerText = Math.round(pp) + "%";
                        finalPoints.push({ x: opening, y: pp, name: inp.dataset.name });
                    }
                });
            } else {
                const fpm = parseFloat(document.getElementById('d6913-fpm').value) || 0;
                const wfp = parseFloat(document.getElementById('d6913-wfp').value) || 0;
                const subSmd = parseFloat(document.getElementById('d6913-sub-smd').value) || 0;
                const cpmd = smdInputVal; 
                
                const fpmd = fpm / (1 + wfp / 100);
                const totalSmd = cpmd + fpmd;
                
                if (totalSmd <= 0 || subSmd <= 0) return alert("يرجى إدخال أوزان العينة والنسب المئوية المطلوبة");

                let cscf = 0;
                cmrn1.forEach((inp, i) => {
                    const opening = parseFloat(inp.dataset.opening);
                    const v = parseFloat(inp.value);
                    if (!isNaN(v)) {
                        const pp = 100 * (1 - v / totalSmd);
                        pp1Display[i].innerText = Math.round(pp) + "%";
                        finalPoints.push({ x: opening, y: pp, name: inp.dataset.name });
                        if (opening === sepOpening) cscf = pp;
                    }
                });

                const cmrn2 = document.querySelectorAll('.d6913-cmrn-2');
                const pp2Display = document.querySelectorAll('.d6913-pp-2');

                cmrn2.forEach((inp, i) => {
                    const opening = parseFloat(inp.dataset.opening);
                    const v = parseFloat(inp.value);
                    if (!isNaN(v)) {
                        const fpp = 100 * (1 - v / subSmd);
                        const finalPP = (fpp / 100) * cscf;
                        pp2Display[i].innerText = Math.round(finalPP) + "%";
                        
                        if (opening === sepOpening && v > (0.02 * subSmd)) {
                            console.warn("Retained on separator in subspecimen > 2%");
                        }

                        if (opening < sepOpening) {
                            finalPoints.push({ x: opening, y: finalPP, name: inp.dataset.name });
                        }
                    }
                });
            }

            if (finalPoints.length > 0) {
                document.getElementById('d6913-results-card').classList.remove('hidden');
                document.getElementById('d6913-final-table-container').classList.remove('hidden');
                renderD6913Chart(finalPoints);
                calculateDValues(finalPoints);
                renderFinalGradationTable(finalPoints);
            }
        }

        function renderFinalGradationTable(points) {
            const tbody = document.getElementById('d6913-final-tbody');
            tbody.innerHTML = '';
            points.sort((a, b) => b.x - a.x);

            let lastCumRet = 0;
            points.forEach((p, i) => {
                const cumRet = 100 - p.y;
                const indRet = cumRet - lastCumRet;
                lastCumRet = cumRet;

                tbody.innerHTML += `
                    <tr>
                        <td class="p-2 border font-bold">${p.name}</td>
                        <td class="p-2 border">${p.x}</td>
                        <td class="p-2 border font-black">${Math.round(p.y)}%</td>
                        <td class="p-2 border">${Math.round(cumRet)}%</td>
                        <td class="p-2 border">${Math.max(0, Math.round(indRet))}%</td>
                    </tr>
                `;
            });
        }

        function calculateDValues(points) {
            points.sort((a, b) => a.x - b.x);
            const interp = (target) => {
                for (let i = 0; i < points.length - 1; i++) {
                    const p1 = points[i], p2 = points[i+1];
                    if ((p1.y <= target && p2.y >= target) || (p1.y >= target && p2.y <= target)) {
                        const logX1 = Math.log10(p1.x), logX2 = Math.log10(p2.x);
                        const tX = logX1 + (target - p1.y) * (logX2 - logX1) / (p2.y - p1.y);
                        return Math.pow(10, tX);
                    }
                }
                return null;
            };

            const d60 = interp(60), d30 = interp(30), d10 = interp(10);
            document.getElementById('d6913-d60').innerText = d60 ? d60.toFixed(3) : 'N/A';
            document.getElementById('d6913-d30').innerText = d30 ? d30.toFixed(3) : 'N/A';
            document.getElementById('d6913-d10').innerText = d10 ? d10.toFixed(3) : 'N/A';
            
            if (d60 && d10) document.getElementById('d6913-cu').innerText = (d60/d10).toFixed(2);
            if (d60 && d30 && d10) document.getElementById('d6913-cc').innerText = (Math.pow(d30,2)/(d60*d10)).toFixed(2);
            
            const panInp = document.querySelector('.d6913-pan-1').value || document.querySelector('.d6913-pan-2').value || 0;
            const minPassing = points.reduce((min, p) => p.y < min ? p.y : min, points[0].y);
            document.getElementById('d6913-pan-final').innerText = minPassing.toFixed(0);
        }

        function renderD6913Chart(points) {
            const ctx = document.getElementById('d6913-chart').getContext('2d');
            if (d6913ChartInstance) d6913ChartInstance.destroy();

            points.sort((a, b) => b.x - a.x);

            d6913ChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'منحنى التدرج',
                        data: points,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Sieve Opening (mm)', font: { weight: 'bold' } },
                            min: 0.01,
                            max: 100,
                            reverse: true,
                            ticks: {
                                callback: function(value) {
                                    if (value === 100 || value === 10 || value === 1 || value === 0.1 || value === 0.01) return value;
                                    return '';
                                }
                            }
                        },
                        y: {
                            min: 0, max: 100,
                            title: { display: true, text: 'Percent Passing (%)', font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }

        function loadD6913Example() {
            const method = document.querySelector('input[name="d6913-method"]:checked').value;
            
            if (method === 'single') {
                document.getElementById('d6913-sample-id').value = "EX-SINGLE";
                document.getElementById('d6913-smd').value = 5000;
                
                // Example data for Single Set
                const vals = [0, 0, 0, 200, 450, 1200, 2100, 3200, 3900, 4400, 4700, 4850, 4920, 4960];
                const inputs = document.querySelectorAll('.d6913-cmrn-1');
                inputs.forEach((inp, i) => {
                    if (i < vals.length) inp.value = vals[i];
                });
                // Pan
                const pan1 = document.querySelector('.d6913-pan-1');
                if(pan1) pan1.value = 4990;

            } else {
                // Composite Mode
                document.getElementById('d6913-sample-id').value = "EX-COMPOSITE";
                
                // Ensure Separator is No.4 (standard for this example)
                const sepSelect = document.getElementById('d6913-separator');
                if(sepSelect.value !== "4.75") {
                    sepSelect.value = "4.75";
                    initD6913Tables(); // Re-init tables for No.4 separator
                }

                // Inputs for Composite
                // CP,Md (Coarse Dry Mass)
                document.getElementById('d6913-smd').value = 2000;
                // FP,Mm (Fine Wet Mass)
                document.getElementById('d6913-fpm').value = 8400;
                // wfp (Water Content %)
                document.getElementById('d6913-wfp').value = 5.0;
                // SubS,Md (Subspecimen Dry Mass)
                document.getElementById('d6913-sub-smd').value = 500;

                // Coarse Table (3" down to No.4)
                // Total Mass approx = 2000 + (8400/1.05) = 10000g.
                // CP Retained at No.4 = CP,Md = 2000g.
                // Sieve Indices (assuming standard set): 
                // 3"(0), 2"(1), 1.5"(2), 1"(3), 3/4"(4), 3/8"(5), No.4(6)
                const coarseVals = [0, 0, 0, 0, 200, 800, 2000]; 
                const coarseInputs = document.querySelectorAll('.d6913-cmrn-1');
                coarseInputs.forEach((inp, i) => {
                    if (i < coarseVals.length) inp.value = coarseVals[i];
                });

                // Fine Table (No.4 down to No.200)
                // Indices in fine table: No.4(0), No.10(1), No.20(2), No.40(3), No.60(4), No.100(5), No.140(6), No.200(7)
                // Start with 0 retained at No.4 (assuming clean separation or taking 0 reference)
                const fineVals = [0, 50, 150, 250, 350, 400, 430, 450];
                const fineInputs = document.querySelectorAll('.d6913-cmrn-2');
                fineInputs.forEach((inp, i) => {
                    if (i < fineVals.length) inp.value = fineVals[i];
                });
                
                // Fine Pan
                const pan2 = document.querySelector('.d6913-pan-2');
                if (pan2) pan2.value = 495;
            }
            
            calculateD6913();
        }

        function resetD6913() {
            document.querySelectorAll('#tab-d6913 input').forEach(inp => inp.value = '');
            document.querySelectorAll('#tab-d6913 select').forEach(sel => sel.selectedIndex = 0);
            document.querySelector('input[name="d6913-method"][value="single"]').checked = true;
            toggleD6913Method();
            if (d6913ChartInstance) d6913ChartInstance.destroy();
            document.getElementById('d6913-results-card').classList.add('hidden');
            document.getElementById('d6913-final-table-container').classList.add('hidden');
        }

        // --- ASTM D1557 MODIFIED PROCTOR ---
        function initProctorTables() {
            const wcTbody = document.getElementById('proctor-wc-tbody');
            const densTbody = document.getElementById('proctor-density-tbody');
            if (!wcTbody || !densTbody) return;
            
            wcTbody.innerHTML = '';
            densTbody.innerHTML = '';

            for(let i=1; i<=5; i++) {
                wcTbody.innerHTML += `
                    <tr>
                        <td class="p-2 border font-bold">${i}</td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field p-wc-wet" oninput="calculateProctor()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field p-wc-dry" oninput="calculateProctor()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field p-wc-tare" oninput="calculateProctor()"></td>
                        <td class="p-2 border calc-val p-wc-water">--</td>
                        <td class="p-2 border calc-val p-wc-soil">--</td>
                        <td class="p-2 border calc-val p-wc-pct">--</td>
                    </tr>
                `;
                densTbody.innerHTML += `
                    <tr>
                        <td class="p-2 border font-bold">${i}</td>
                        <td class="p-1 border"><input type="number" step="0.1" class="input-field p-dens-total" oninput="calculateProctor()"></td>
                        <td class="p-2 border calc-val p-dens-moist">--</td>
                        <td class="p-2 border calc-val p-dens-dry">--</td>
                    </tr>
                `;
            }
        }

        function calculateProctor() {
            const unitSystem = document.getElementById('proctor-unit-system').value;
            const moldMass = parseFloat(document.getElementById('proctor-mold-mass').value) || 0;
            const moldVolIn = parseFloat(document.getElementById('proctor-mold-vol').value) || 0;
            const moldVolUnit = document.getElementById('proctor-mold-vol-unit').value;
            const gs = parseFloat(document.getElementById('proctor-gs').value) || 2.65;
            const moldVolM3 = (moldVolUnit === 'cm3') ? moldVolIn * 1e-6 : moldVolIn;

            const unitLbl = unitSystem === 'g_cm3' ? 'g/cm³' : (unitSystem === 'kg_m3' ? 'kg/m³' : 'kN/m³');
            document.getElementById('proctor-moist-label').innerText = (unitSystem === 'kN_m3' ? 'Moist Unit Wt' : 'الكثافة الرطبة') + ` (${unitLbl})`;
            document.getElementById('proctor-dry-label').innerText = (unitSystem === 'kN_m3' ? 'Dry Unit Wt' : 'الكثافة الجافة') + ` (${unitLbl})`;
            document.getElementById('proctor-res-unit').innerText = unitLbl;

            const wetInputs = document.querySelectorAll('.p-wc-wet');
            const dryInputs = document.querySelectorAll('.p-wc-dry');
            const tareInputs = document.querySelectorAll('.p-wc-tare');
            const soilTotalInputs = document.querySelectorAll('.p-dens-total');

            const points = [];

            for (let i = 0; i < 5; i++) {
                const w = parseFloat(wetInputs[i].value);
                const d = parseFloat(dryInputs[i].value);
                const t = parseFloat(tareInputs[i].value);
                const totalM = parseFloat(soilTotalInputs[i].value);

                if (!isNaN(w) && !isNaN(d) && !isNaN(t) && !isNaN(totalM) && moldVolM3 > 0) {
                    const water = w - d;
                    const drySoil = d - t;
                    const moisture = (water / drySoil) * 100;

                    if (document.querySelectorAll('.p-wc-water')[i]) document.querySelectorAll('.p-wc-water')[i].innerText = water.toFixed(2);
                    if (document.querySelectorAll('.p-wc-soil')[i]) document.querySelectorAll('.p-wc-soil')[i].innerText = drySoil.toFixed(2);
                    if (document.querySelectorAll('.p-wc-pct')[i]) document.querySelectorAll('.p-wc-pct')[i].innerText = moisture.toFixed(2);

                    const rhoM_kgm3 = ((totalM - moldMass) / 1000) / moldVolM3;
                    const rhoD_kgm3 = rhoM_kgm3 / (1 + (moisture / 100));

                    let dm, dd;
                    if (unitSystem === 'g_cm3') {
                        dm = rhoM_kgm3 / 1000;
                        dd = rhoD_kgm3 / 1000;
                    } else if (unitSystem === 'kg_m3') {
                        dm = rhoM_kgm3;
                        dd = rhoD_kgm3;
                    } else {
                        // kN/m3
                        dm = (rhoM_kgm3 * 9.80665) / 1000;
                        dd = (rhoD_kgm3 * 9.80665) / 1000;
                    }

                    if (document.querySelectorAll('.p-dens-moist')[i]) document.querySelectorAll('.p-dens-moist')[i].innerText = dm.toFixed(3);
                    if (document.querySelectorAll('.p-dens-dry')[i]) document.querySelectorAll('.p-dens-dry')[i].innerText = dd.toFixed(3);

                    points.push({ x: moisture, y: dd, base_kgm3: rhoD_kgm3 });
                }
            }

            if (points.length >= 3) {
                document.getElementById('proctor-results-container').classList.remove('hidden');
                points.sort((a, b) => a.x - b.x);

                let maxP = points[0];
                points.forEach(p => { if (p.y > maxP.y) maxP = p; });

                document.getElementById('proctor-res-omc').innerText = maxP.x.toFixed(1);
                document.getElementById('proctor-res-mdd').innerText = maxP.y.toFixed(3);

                const bVal = maxP.base_kgm3;
                const gcm3 = (bVal / 1000).toFixed(3);
                const kgm3 = bVal.toFixed(0);
                const knm3 = ((bVal * 9.80665) / 1000).toFixed(2);
                document.getElementById('proctor-res-alt').innerText = `${gcm3} g/cm³ | ${kgm3} kg/m³ | ${knm3} kN/m³`;

                renderProctorChart(points, gs, unitSystem);
            }
        }

        function renderProctorChart(points, gs, unitSys) {
            const ctx = document.getElementById('proctor-chart').getContext('2d');
            const zav = [];
            const minW = Math.max(0, points[0].x - 4);
            const maxW = points[points.length - 1].x + 6;
            for (let w = minW; w <= maxW; w += 0.5) {
                const rhoD_kgm3 = (gs * 1000) / (1 + (w * gs / 100));
                let y;
                if (unitSys === 'g_cm3') y = rhoD_kgm3 / 1000;
                else if (unitSys === 'kg_m3') y = rhoD_kgm3;
                else y = (rhoD_kgm3 * 9.80665) / 1000;
                zav.push({ x: w, y: y });
            }

            if (proctorChartInstance) proctorChartInstance.destroy();
            proctorChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'منحنى الدمك',
                            data: points,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderWidth: 3,
                            pointRadius: 6,
                            tension: 0.4
                        },
                        {
                            label: 'ZAV (S=100%)',
                            data: zav,
                            borderColor: '#94a3b8',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Moisture Content (%)', font: { weight: 'bold' } } },
                        y: { title: { display: true, text: `Dry Density (${unitSys})`, font: { weight: 'bold' } } }
                    }
                }
            });
        }

        function loadProctorExample() {
            document.getElementById('proctor-sample-id').value = "EX-1557";
            document.getElementById('proctor-unit-system').value = "kg_m3";
            document.getElementById('proctor-mold-mass').value = 4250;
            document.getElementById('proctor-mold-vol').value = 944;
            document.getElementById('proctor-mold-vol-unit').value = 'cm3';
            
            // Data targeting ~2150 kg/m3 max
            const wets = [135, 145, 155, 165, 175];
            const drys = [128.5, 137, 145, 153, 160.5];
            const tares = [40, 40, 40, 40, 40];
            const totals = [6280, 6380, 6460, 6455, 6400]; // Mold+Wet Soil
            
            for (let i = 0; i < 5; i++) {
                document.querySelectorAll('.p-wc-wet')[i].value = wets[i];
                document.querySelectorAll('.p-wc-dry')[i].value = drys[i];
                document.querySelectorAll('.p-wc-tare')[i].value = tares[i];
                document.querySelectorAll('.p-dens-total')[i].value = totals[i];
            }
            calculateProctor();
        }

        function resetProctor() {
            document.querySelectorAll('#tab-d1557 input').forEach(inp => inp.value = '');
            initProctorTables();
            if (proctorChartInstance) proctorChartInstance.destroy();
            document.getElementById('proctor-results-container').classList.add('hidden');
        }

        // --- ASTM D4318 ATTERBERG LIMITS ---
        function initAtterbergTables() {
            const llTbody = document.getElementById('atterberg-ll-tbody');
            const plTbody = document.getElementById('atterberg-pl-tbody');
            llTbody.innerHTML = '';
            plTbody.innerHTML = '';
            for(let i=1; i<=3; i++) {
                llTbody.innerHTML += `
                    <tr>
                        <td class="p-2 border font-bold">${i}</td>
                        <td class="p-1 border"><input type="number" class="input-field a-ll-n" oninput="calculateAtterberg()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-ll-wet" oninput="calculateAtterberg()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-ll-dry" oninput="calculateAtterberg()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-ll-tare" oninput="calculateAtterberg()"></td>
                        <td class="p-2 border calc-val a-ll-water">--</td>
                        <td class="p-2 border calc-val a-ll-soil">--</td>
                        <td class="p-2 border calc-val a-ll-pct">--</td>
                    </tr>
                `;
            }
            for(let i=1; i<=2; i++) {
                plTbody.innerHTML += `
                    <tr>
                        <td class="p-2 border font-bold">${i}</td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-pl-wet" oninput="calculateAtterberg()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-pl-dry" oninput="calculateAtterberg()"></td>
                        <td class="p-1 border"><input type="number" step="0.01" class="input-field a-pl-tare" oninput="calculateAtterberg()"></td>
                        <td class="p-2 border calc-val a-pl-water">--</td>
                        <td class="p-2 border calc-val a-pl-soil">--</td>
                        <td class="p-2 border calc-val a-pl-pct">--</td>
                    </tr>
                `;
            }
        }

        function calculateAtterberg() {
            const llN = document.querySelectorAll('.a-ll-n');
            const llW = document.querySelectorAll('.a-ll-wet');
            const llD = document.querySelectorAll('.a-ll-dry');
            const llT = document.querySelectorAll('.a-ll-tare');
            const plW = document.querySelectorAll('.a-pl-wet');
            const plD = document.querySelectorAll('.a-pl-dry');
            const plT = document.querySelectorAll('.a-pl-tare');

            const llPoints = [];
            for (let i = 0; i < 3; i++) {
                const n = parseFloat(llN[i].value), w = parseFloat(llW[i].value), d = parseFloat(llD[i].value), t = parseFloat(llT[i].value);
                if (!isNaN(n) && !isNaN(w) && !isNaN(d) && !isNaN(t)) {
                    const water = w - d, soil = d - t, pct = (water / soil) * 100;
                    document.querySelectorAll('.a-ll-water')[i].innerText = water.toFixed(2);
                    document.querySelectorAll('.a-ll-soil')[i].innerText = soil.toFixed(2);
                    document.querySelectorAll('.a-ll-pct')[i].innerText = pct.toFixed(2);
                    llPoints.push({ x: Math.log10(n), y: pct, n: n });
                }
            }

            const plVals = [];
            for (let i = 0; i < 2; i++) {
                const w = parseFloat(plW[i].value), d = parseFloat(plD[i].value), t = parseFloat(plT[i].value);
                if (!isNaN(w) && !isNaN(d) && !isNaN(t)) {
                    const water = w - d, soil = d - t, pct = (water / soil) * 100;
                    document.querySelectorAll('.a-pl-water')[i].innerText = water.toFixed(2);
                    document.querySelectorAll('.a-pl-soil')[i].innerText = soil.toFixed(2);
                    document.querySelectorAll('.a-pl-pct')[i].innerText = pct.toFixed(2);
                    plVals.push(pct);
                }
            }

            if (llPoints.length >= 2) {
                document.getElementById('atterberg-results-container').classList.remove('hidden');
                const n = llPoints.length;
                let sx = 0, sy = 0, sxy = 0, sx2 = 0;
                llPoints.forEach(p => { sx += p.x; sy += p.y; sxy += p.x * p.y; sx2 += p.x * p.x; });
                const slope = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
                const intercept = (sy - slope * sx) / n;
                const LL = slope * Math.log10(25) + intercept;
                document.getElementById('atterberg-res-ll').innerText = LL.toFixed(1);

                if (plVals.length > 0) {
                    const PL = plVals.reduce((a, b) => a + b) / plVals.length;
                    const PI = Math.max(0, LL - PL);
                    document.getElementById('atterberg-res-pl').innerText = PL.toFixed(1);
                    document.getElementById('atterberg-res-pi').innerText = PI.toFixed(1);
                    document.getElementById('atterberg-state-badge').innerText = "الحالة: " + (PI > 0.73 * (LL - 20) ? "CL/CH (فوق خط A)" : "ML/MH (تحت خط A)");
                }
                renderAtterbergChart(llPoints, slope, intercept);
            }
        }

        function renderAtterbergChart(points, m, c) {
            const ctx = document.getElementById('atterberg-chart').getContext('2d');
            const flowCurve = [ { x: 10, y: m * Math.log10(10) + c }, { x: 50, y: m * Math.log10(50) + c } ];
            if (atterbergChartInstance) atterbergChartInstance.destroy();
            atterbergChartInstance = new Chart(ctx, {
                data: {
                    datasets: [
                        { type: 'scatter', label: 'نقاط الاختبار', data: points.map(p => ({ x: p.n, y: p.y })), backgroundColor: '#6366f1', pointRadius: 6 },
                        { type: 'line', label: 'خط الانسياب', data: flowCurve, borderColor: 'rgba(99, 102, 241, 0.4)', borderWidth: 2, fill: false, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'logarithmic', title: { display: true, text: 'Number of Blows (N)' }, min: 10, max: 100, ticks: { callback: v => v } },
                        y: { title: { display: true, text: 'Water Content (%)' } }
                    }
                }
            });
        }

        function loadAtterbergExample() {
            document.getElementById('atterberg-sample-id').value = "EX-4318";
            
            // LL Data targeting LL ~ 42
            const ns = [34, 25, 17];
            const lw = [38.5, 41.2, 44.8];
            const ld = [30.4, 32.1, 34.5];
            const lt = [12.5, 12.5, 12.5];
            
            // PL Data targeting PL ~ 26
            const pw = [25.4, 25.8];
            const pd = [22.8, 23.1];
            const pt = [12.5, 12.5];

            const nInp = document.querySelectorAll('.a-ll-n');
            const wInp = document.querySelectorAll('.a-ll-wet');
            const dInp = document.querySelectorAll('.a-ll-dry');
            const tInp = document.querySelectorAll('.a-ll-tare');

            for (let i = 0; i < 3; i++) {
                if(nInp[i]) nInp[i].value = ns[i];
                if(wInp[i]) wInp[i].value = lw[i];
                if(dInp[i]) dInp[i].value = ld[i];
                if(tInp[i]) tInp[i].value = lt[i];
            }

            const pwInp = document.querySelectorAll('.a-pl-wet');
            const pdInp = document.querySelectorAll('.a-pl-dry');
            const ptInp = document.querySelectorAll('.a-pl-tare');

            for (let i = 0; i < 2; i++) {
                if(pwInp[i]) pwInp[i].value = pw[i];
                if(pdInp[i]) pdInp[i].value = pd[i];
                if(ptInp[i]) ptInp[i].value = pt[i];
            }
            
            calculateAtterberg();
        }

        function resetAtterberg() {
            document.querySelectorAll('#tab-d4318 input').forEach(inp => inp.value = '');
            document.querySelector('input[name="d4318-method"][value="A"]').checked = true;
            toggleD4318Method();
            initAtterbergTables();
            if (atterbergChartInstance) atterbergChartInstance.destroy();
            document.getElementById('atterberg-results-container').classList.add('hidden');
        }

        // --- ASTM D4318 NEW LOGIC ---

        function toggleD4318Method() {
            const method = document.querySelector('input[name="d4318-method"]:checked').value;
            const rows = document.getElementById('atterberg-ll-tbody').querySelectorAll('tr');
            const note = document.getElementById('d4318-note');
            
            if (method === 'B') {
                // Method B: One-point (Use first 2 rows usually, hide 3rd)
                if (rows[2]) rows[2].classList.add('hidden');
                note.innerText = "* ملاحظة (Method B): يلزم نقطة واحدة على الأقل، ويجب أن تكون الضربات (N) بين 20 و 30.";
            } else {
                // Method A: Multipoint
                if (rows[2]) rows[2].classList.remove('hidden');
                note.innerText = "* ملاحظة (Method A): يجب أن تكون قيم الضربات موزعة بين (15-35) ضربة.";
            }
            // Re-calc if data exists
            calculateAtterberg();
        }

        // Updated Calculation Logic for A/B
        const originalCalculateAtterberg = calculateAtterberg; // Backup old if needed, but we will overwrite logic inside the existing function or simpler: replace it below.
        
        // Overwriting calculateAtterberg with A/B support
        calculateAtterberg = function() {
            const method = document.querySelector('input[name="d4318-method"]:checked').value;
            
            const llN = document.querySelectorAll('.a-ll-n');
            const llW = document.querySelectorAll('.a-ll-wet');
            const llD = document.querySelectorAll('.a-ll-dry');
            const llT = document.querySelectorAll('.a-ll-tare');
            
            // LL Calculation
            let llPoints = [];
            let llSum = 0;
            let llCount = 0;

            // Iterate 3 rows (or 2 if B, but loop 3 safe as hidden input is empty/ignored)
            for (let i = 0; i < 3; i++) {
                // Skip row 3 if Method B
                if (method === 'B' && i === 2) continue;

                const n = parseFloat(llN[i].value), w = parseFloat(llW[i].value), d = parseFloat(llD[i].value), t = parseFloat(llT[i].value);
                if (!isNaN(n) && !isNaN(w) && !isNaN(d) && !isNaN(t)) {
                    const water = w - d, soil = d - t, pct = (water / soil) * 100;
                    document.querySelectorAll('.a-ll-water')[i].innerText = water.toFixed(2);
                    document.querySelectorAll('.a-ll-soil')[i].innerText = soil.toFixed(2);
                    document.querySelectorAll('.a-ll-pct')[i].innerText = pct.toFixed(2);
                    
                    if (method === 'A') {
                        llPoints.push({ x: Math.log10(n), y: pct, n: n });
                    } else {
                        // Method B Equation: LL = wn * (N/25)^0.121
                        // Valid only if N is 20-30
                        if (n >= 20 && n <= 30) {
                            const llOnePoint = pct * Math.pow(n / 25, 0.121);
                            llSum += llOnePoint;
                            llCount++;
                            llPoints.push({ x: n, y: pct, llOne: llOnePoint }); // Just for storage
                        }
                    }
                }
            }

            // PL Calculation
            const plW = document.querySelectorAll('.a-pl-wet');
            const plD = document.querySelectorAll('.a-pl-dry');
            const plT = document.querySelectorAll('.a-pl-tare');
            const plVals = [];
            for (let i = 0; i < 2; i++) {
                const w = parseFloat(plW[i].value), d = parseFloat(plD[i].value), t = parseFloat(plT[i].value);
                if (!isNaN(w) && !isNaN(d) && !isNaN(t)) {
                    const water = w - d, soil = d - t, pct = (water / soil) * 100;
                    document.querySelectorAll('.a-pl-water')[i].innerText = water.toFixed(2);
                    document.querySelectorAll('.a-pl-soil')[i].innerText = soil.toFixed(2);
                    document.querySelectorAll('.a-pl-pct')[i].innerText = pct.toFixed(2);
                    plVals.push(pct);
                }
            }

            // Results Logic
            let finalLL = null;

            if (method === 'A' && llPoints.length >= 2) {
                // Regression for A
                const n = llPoints.length;
                let sx = 0, sy = 0, sxy = 0, sx2 = 0;
                llPoints.forEach(p => { sx += p.x; sy += p.y; sxy += p.x * p.y; sx2 += p.x * p.x; });
                const slope = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
                const intercept = (sy - slope * sx) / n;
                finalLL = slope * Math.log10(25) + intercept;
                
                renderAtterbergChart(llPoints, slope, intercept, 'A');

            } else if (method === 'B' && llCount > 0) {
                // Average for B
                finalLL = llSum / llCount;
                renderAtterbergChart(llPoints, 0, 0, 'B'); // No regression line
            }

            if (finalLL !== null) {
                document.getElementById('atterberg-results-container').classList.remove('hidden');
                document.getElementById('atterberg-res-ll').innerText = finalLL.toFixed(1);

                if (plVals.length > 0) {
                    const PL = plVals.reduce((a, b) => a + b) / plVals.length;
                    const PI = Math.max(0, finalLL - PL);
                    document.getElementById('atterberg-res-pl').innerText = PL.toFixed(1);
                    document.getElementById('atterberg-res-pi').innerText = PI.toFixed(1);
                    
                    // A-Line Classification Logic
                    // CL if LL<50 and PI > 0.73(LL-20)
                    // CH if LL>=50 and PI > 0.73(LL-20)
                    // ML if LL<50 and PI < 0.73(LL-20)
                    // MH if LL>=50 and PI < 0.73(LL-20)
                    // Dual symbols CL-ML if PI between 4 and 7 and LL low... simplified here:
                    const A_line = 0.73 * (finalLL - 20);
                    let classStr = "";
                    if (PI >= A_line) {
                         classStr = (finalLL < 50) ? "CL (Low Plasticity Clay)" : "CH (High Plasticity Clay)";
                    } else {
                         classStr = (finalLL < 50) ? "ML (Low Plasticity Silt)" : "MH (High Plasticity Silt)";
                    }
                    document.getElementById('atterberg-state-badge').innerText = "تصنيف مبدئي: " + classStr;
                }
            }
        };

        // Update Chart for A/B
        function renderAtterbergChart(points, m, c, method) {
            const ctx = document.getElementById('atterberg-chart').getContext('2d');
            if (atterbergChartInstance) atterbergChartInstance.destroy();

            let datasets = [];
            let xScale = {};

            if (method === 'A') {
                const flowCurve = [ { x: 10, y: m * Math.log10(10) + c }, { x: 50, y: m * Math.log10(50) + c } ];
                datasets = [
                    { type: 'scatter', label: 'نقاط الاختبار', data: points.map(p => ({ x: p.n, y: p.y })), backgroundColor: '#6366f1', pointRadius: 6 },
                    { type: 'line', label: 'خط الانسياب (Flow Line)', data: flowCurve, borderColor: 'rgba(99, 102, 241, 0.4)', borderWidth: 2, fill: false, pointRadius: 0 }
                ];
                xScale = { type: 'logarithmic', title: { display: true, text: 'Number of Blows (N)' }, min: 10, max: 100, ticks: { callback: v => v } };
            } else {
                // Method B - Just points, maybe line at 25
                datasets = [
                     { type: 'scatter', label: 'نقاط الاختبار (One-Point)', data: points.map(p => ({ x: p.x, y: p.y })), backgroundColor: '#ec4899', pointRadius: 8 }
                ];
                xScale = { type: 'linear', title: { display: true, text: 'Number of Blows (N)' }, min: 10, max: 40 };
            }

            atterbergChartInstance = new Chart(ctx, {
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: xScale,
                        y: { title: { display: true, text: 'Water Content (%)' } }
                    }
                }
            });
        }

        // Updated Example Loader
        loadAtterbergExample = function() {
            const method = document.querySelector('input[name="d4318-method"]:checked').value;
            
            document.getElementById('atterberg-sample-id').value = "EX-" + method;
            
            // Common PL Data (Target ~26)
            const pw = [25.4, 25.8];
            const pd = [22.8, 23.1];
            const pt = [12.5, 12.5];
            const pwInp = document.querySelectorAll('.a-pl-wet');
            const pdInp = document.querySelectorAll('.a-pl-dry');
            const ptInp = document.querySelectorAll('.a-pl-tare');
            for (let i = 0; i < 2; i++) {
                if(pwInp[i]) pwInp[i].value = pw[i];
                if(pdInp[i]) pdInp[i].value = pd[i];
                if(ptInp[i]) ptInp[i].value = pt[i];
            }

            // LL Data
            const nInp = document.querySelectorAll('.a-ll-n');
            const wInp = document.querySelectorAll('.a-ll-wet');
            const dInp = document.querySelectorAll('.a-ll-dry');
            const tInp = document.querySelectorAll('.a-ll-tare');
            
            // Clear first
            for(let i=0; i<3; i++) { nInp[i].value=''; wInp[i].value=''; dInp[i].value=''; tInp[i].value=''; }

            if (method === 'A') {
                // Method A: 3 points distributed
                const ns = [34, 25, 17];
                const lw = [38.5, 41.2, 44.8];
                const ld = [30.4, 32.1, 34.5];
                const lt = [12.5, 12.5, 12.5];
                for (let i = 0; i < 3; i++) {
                    nInp[i].value = ns[i]; wInp[i].value = lw[i]; dInp[i].value = ld[i]; tInp[i].value = lt[i];
                }
            } else {
                // Method B: 1 or 2 points close to 25 (e.g., 24)
                // Point 1: N=24, w=41.5% -> LL = 41.5 * (24/25)^0.121 ~= 41.3
                const ns = [24, 28]; // Just 2 points
                const lw = [41.5, 40.8]; // Slightly drier for higher N
                const ld = [32.0, 31.8]; // approx
                const lt = [12.5, 12.5];

                // Dry = Wet / (1+w) + tare... simplified estimation
                // For N=24, w=41.5: Wet=41.5, Tare=12.5, Dry=32.9? No.
                // Let's just set hard values that work.
                // Point 1: N=24
                nInp[0].value = 24; wInp[0].value = 45.5; dInp[0].value = 35.8; tInp[0].value = 12.5; // w ~ 41.6%
                
                // Point 2: N=28
                nInp[1].value = 28; wInp[1].value = 44.8; dInp[1].value = 35.5; tInp[1].value = 12.5; // w ~ 40.4%
            }
            
            calculateAtterberg();
        };
    </script>
</body>
</html>
