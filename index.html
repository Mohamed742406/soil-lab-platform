<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ÙŠØ© Ù„Ù„ØªØ±Ø¨Ø© - Soil Laboratory Testing Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom Table Styling */
        .lab-table th {
            background-color: #e5e7eb;
            color: #1f2937;
            font-weight: 700;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            text-align: center;
            font-size: 0.9rem;
        }
        .lab-table td {
            border: 1px solid #d1d5db;
            padding: 0.25rem;
            text-align: center;
        }
        .lab-input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            text-align: center;
            direction: ltr; /* Numbers LTR */
        }
        .lab-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .readonly-cell {
            background-color: #f9fafb;
            color: #4b5563;
        }
        
        /* Chrome/Safari/Edge number input arrows hide */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Tab Active State */
        .tab-active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: bold;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .tab-inactive {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
        }
        .tab-inactive:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        
        /* Mathjax-like symbols support if needed, but plain HTML is used mostly */
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Platform Header -->
    <div class="max-w-6xl mx-auto mb-8 text-center border-b border-gray-300 pb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ÙŠØ© Ù„Ù„ØªØ±Ø¨Ø©</h1>
        <h2 class="text-xl text-gray-600 font-medium mb-3 dir-ltr">Soil Laboratory Testing Platform</h2>
        <div class="inline-block bg-white border border-gray-200 rounded-full px-4 py-1 text-sm text-gray-500 shadow-sm">
            ØªÙ… ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù†ØµØ©: <span class="font-bold text-gray-700">Ù…. Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚ØµØ¨Ù‰</span>
        </div>
    </div>

    <!-- Top Navigation / Tabs -->
    <div class="max-w-6xl mx-auto mb-6">
        <div class="flex space-x-2 space-x-reverse border-b-2 border-gray-300 pb-1 overflow-x-auto">
            <button onclick="switchTab('d6913')" id="tab-d6913" class="px-6 py-2 rounded-t-lg tab-active transition-colors">ØªØ¯Ø±Ø¬ Ø§Ù„ØªØ±Ø¨Ø© (D6913)</button>
            <button onclick="switchTab('d1557')" id="tab-d1557" class="px-6 py-2 rounded-t-lg tab-inactive transition-colors">Modified Proctor (D1557)</button>
            <button onclick="switchTab('d4318')" id="tab-d4318" class="px-6 py-2 rounded-t-lg tab-inactive transition-colors">Ø­Ø¯ÙˆØ¯ Ø£ØªØ±Ø¨Ø±Ø¬ (D4318)</button>
        </div>
    </div>

    <!-- D6913 SECTION -->
    <div id="d6913Section" class="max-w-6xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden border border-gray-200">
        
        <!-- Header -->
        <div class="bg-gray-800 text-white p-4">
            <h1 class="text-2xl font-bold text-center">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø­Ø¨ÙŠØ¨ÙŠ â€” ASTM D6913</h1>
            <p class="text-center text-gray-300 text-sm mt-1">Particle-Size Distribution (Gradation) of Soils Using Sieve Analysis</p>
        </div>

        <!-- Controls & Meta Data -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 border-b border-gray-200">
            
            <!-- Method Selection -->
            <div class="md:col-span-1 space-y-3">
                <h3 class="font-bold text-gray-700 border-b pb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Method Selection)</h3>
                <div class="flex flex-col space-y-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="method" value="composite" class="form-radio text-blue-600 h-5 w-5" checked onchange="toggleMethod()">
                        <span class="mr-2 text-gray-800">Composite (ÙØµÙ„ Ø¹Ù†Ø¯ Ù…Ù†Ø®Ù„)</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="method" value="single" class="form-radio text-blue-600 h-5 w-5" onchange="toggleMethod()">
                        <span class="mr-2 text-gray-800">Single-Set (Ø¹ÙŠÙ†Ø© ÙƒØ§Ù…Ù„Ø©)</span>
                    </label>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">ÙˆØ­Ø¯Ø© Ø§Ù„ÙƒØªÙ„Ø©</label>
                    <select id="massUnit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border p-1" onchange="updateLabels()">
                        <option value="g">Ø¬Ø±Ø§Ù… (g)</option>
                        <option value="kg">ÙƒÙŠÙ„ÙˆØ¬Ø±Ø§Ù… (kg)</option>
                    </select>
                </div>
            </div>

            <!-- Sample Info -->
            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠÙ†Ø© (Sample ID)</label>
                    <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ® (Date)</label>
                    <input type="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Remarks)</label>
                    <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
        </div>

        <!-- Dynamic Inputs Section -->
        <div class="p-6">
            
            <!-- Messages Area -->
            <div id="messageArea" class="hidden mb-4 p-4 rounded-md"></div>

            <!-- Composite Method Inputs -->
            <div id="compositeInputs" class="space-y-6">
                
                <!-- Separation Sieve Selection -->
                <div class="bg-gray-100 p-4 rounded-lg border border-gray-300">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ù…Ù†Ø®Ù„ Ø§Ù„ÙØµÙ„ (Designated Separating Sieve)</label>
                    <select id="separatingSieve" class="block w-full md:w-1/2 border-gray-300 rounded-md shadow-sm border p-2" onchange="handleSeparationChange()">
                        <option value="19.0">3/4 in (19.0 mm)</option>
                        <option value="9.5">3/8 in (9.5 mm)</option>
                        <option value="4.75" selected>No.4 (4.75 mm)</option>
                        <option value="2.00">No.10 (2.00 mm)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">ÙŠØ­Ø¯Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø¯ Ø§Ù„ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† (CP & SubS). Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±.</p>
                </div>

                <!-- Initial Mass Data -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-3 border-b border-blue-200 pb-1">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Composite Calculation)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        
                        <!-- CP,Md -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" title="Dry mass of Coarse Portion">ÙˆØ²Ù† Ø§Ù„Ø®Ø´Ù† Ø§Ù„Ø¬Ø§Ù <span class="text-xs font-mono bg-gray-200 p-0.5 rounded">CP,Md</span></label>
                            <div class="relative">
                                <input type="number" id="cp_md" step="0.01" class="block w-full border-gray-300 rounded-md border p-2 pl-8">
                                <span class="absolute left-2 top-2 text-gray-500 text-sm unit-label">g</span>
                            </div>
                        </div>

                        <!-- FP,Mm -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" title="Moist mass of Fine Portion">ÙˆØ²Ù† Ø§Ù„Ù†Ø§Ø¹Ù… Ø§Ù„Ø±Ø·Ø¨ <span class="text-xs font-mono bg-gray-200 p-0.5 rounded">FP,Mm</span></label>
                            <div class="relative">
                                <input type="number" id="fp_mm" step="0.01" class="block w-full border-gray-300 rounded-md border p-2 pl-8">
                                <span class="absolute left-2 top-2 text-gray-500 text-sm unit-label">g</span>
                            </div>
                        </div>

                        <!-- wfp -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" title="Water content of Fine Portion">Ù…Ø­ØªÙˆÙ‰ Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù†Ø§Ø¹Ù… <span class="text-xs font-mono bg-gray-200 p-0.5 rounded">wfp</span></label>
                            <div class="relative">
                                <input type="number" id="wfp" step="0.1" class="block w-full border-gray-300 rounded-md border p-2 pl-8">
                                <span class="absolute left-2 top-2 text-gray-500 text-sm">%</span>
                            </div>
                        </div>

                        <!-- SubS,Md -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1" title="Dry mass of Subspecimen">ÙˆØ²Ù† Ø¹ÙŠÙ†Ø© Ø§Ù„Ù†Ø§Ø¹Ù… Ø§Ù„Ø¬Ø§ÙØ© <span class="text-xs font-mono bg-gray-200 p-0.5 rounded">SubS,Md</span></label>
                            <div class="relative">
                                <input type="number" id="subs_md" step="0.01" class="block w-full border-gray-300 rounded-md border p-2 pl-8">
                                <span class="absolute left-2 top-2 text-gray-500 text-sm unit-label">g</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calculated Totals Preview -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 bg-white p-3 rounded border border-gray-200">
                        <div>
                            <span class="font-bold">ÙˆØ²Ù† Ø§Ù„Ù†Ø§Ø¹Ù… Ø§Ù„Ø¬Ø§Ù (Calculated FP,Md):</span> 
                            <span id="calc_fp_md" class="font-mono text-blue-600 font-bold mx-2">-</span> <span class="unit-label">g</span>
                        </div>
                        <div>
                            <span class="font-bold">ÙˆØ²Ù† Ø§Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø¬Ø§Ù (Calculated S,Md):</span> 
                            <span id="calc_s_md" class="font-mono text-blue-600 font-bold mx-2">-</span> <span class="unit-label">g</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Coarse Table -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">1. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø´Ù† (Coarse Portion) â€” Ø­ØªÙ‰ Ù…Ù†Ø®Ù„ Ø§Ù„ÙØµÙ„</h4>
                        <table class="w-full lab-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†Ø®Ù„ (Sieve)</th>
                                    <th>Ø§Ù„ÙØªØ­Ø© (mm)</th>
                                    <th>Ø§Ù„Ù…Ø­ØªØ¬Ø² ØªØ±Ø§ÙƒÙ…ÙŠ<br><span class="text-xs font-mono">CP,CMRN</span></th>
                                    <th>% Ø§Ù„Ù…Ø§Ø±<br><span class="text-xs font-mono">Passing %</span></th>
                                </tr>
                            </thead>
                            <tbody id="coarseTableBody">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Fine Table -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">2. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù†Ø§Ø¹Ù… (Fine Portion) â€” Ù…Ù† Ù…Ù†Ø®Ù„ Ø§Ù„ÙØµÙ„</h4>
                        <table class="w-full lab-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ù…Ù†Ø®Ù„ (Sieve)</th>
                                    <th>Ø§Ù„ÙØªØ­Ø© (mm)</th>
                                    <th>Ù…Ø­ØªØ¬Ø² Ø§Ù„Ø¹ÙŠÙ†Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©<br><span class="text-xs font-mono">SubS,FCMRN</span></th>
                                    <th>% Ù…Ø§Ø± ÙƒÙ„ÙŠ<br><span class="text-xs font-mono">Final Passing</span></th>
                                </tr>
                            </thead>
                            <tbody id="fineTableBody">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Single Set Inputs -->
            <div id="singleInputs" class="hidden space-y-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 max-w-md">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø¬Ø§Ù Ù„Ù„Ø¹ÙŠÙ†Ø© <span class="text-xs font-mono bg-gray-200 p-0.5 rounded">S,Md</span></label>
                    <div class="relative">
                        <input type="number" id="single_s_md" step="0.01" class="block w-full border-gray-300 rounded-md border p-2 pl-8">
                        <span class="absolute left-2 top-2 text-gray-500 text-sm unit-label">g</span>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-gray-800 mb-2">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø®Ù„ (Single Set Sieving)</h4>
                    <table class="w-full lab-table max-w-2xl">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù†Ø®Ù„ (Sieve)</th>
                                <th>Ø§Ù„ÙØªØ­Ø© (mm)</th>
                                <th>Ø§Ù„Ù…Ø­ØªØ¬Ø² ØªØ±Ø§ÙƒÙ…ÙŠ<br><span class="text-xs font-mono">CMRN</span></th>
                                <th>% Ø§Ù„Ù…Ø§Ø±<br><span class="text-xs font-mono">Passing %</span></th>
                            </tr>
                        </thead>
                        <tbody id="singleTableBody">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex flex-wrap gap-4 border-t pt-6">
                <button onclick="calculate()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded shadow flex items-center">
                    <span class="ml-2">âš¡</span> Ø§Ø­Ø³Ø¨ (Calculate)
                </button>
                <button onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow">
                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† (Reset)
                </button>
                <button onclick="loadExampleData()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 px-6 rounded shadow border border-purple-300">
                    Ù…Ù„Ø¡ Ù…Ø«Ø§Ù„ (Demo Data)
                </button>
            </div>

            <!-- Results Summary -->
            <div id="resultsSummary" class="hidden mt-8 bg-green-50 border border-green-200 p-4 rounded-lg">
                <h3 class="font-bold text-green-800 border-b border-green-200 pb-2 mb-2">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Calculation Summary)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <div id="res_s_md_box">
                        <span class="block text-gray-500">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø¬Ø§Ù (S,Md)</span>
                        <span id="res_s_md" class="font-mono font-bold text-lg">-</span> <span class="unit-label"></span>
                    </div>
                    <div id="res_cscf_box">
                        <span class="block text-gray-500">Ù…Ø¹Ø§Ù…Ù„ ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø´Ù† (CSCF)</span>
                        <span id="res_cscf" class="font-mono font-bold text-lg">-</span> %
                    </div>
                    <div>
                        <span class="block text-gray-500">D10 (Approx)</span>
                        <span id="res_d10" class="font-mono font-bold text-lg">-</span> mm
                    </div>
                    <div>
                        <span class="block text-gray-500">Gravel / Sand / Fines</span>
                        <span id="res_comp" class="font-mono font-bold text-xs">-</span>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="mt-8 bg-white p-4 border rounded-lg shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4 text-center">Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø­Ø¨ÙŠØ¨ÙŠ (Particle-Size Distribution Curve)</h3>
                <div class="relative h-96 w-full">
                    <canvas id="gradationChart"></canvas>
                </div>
            </div>

        </div>
        
        <!-- Footer -->
        <div class="bg-gray-100 p-4 text-center text-gray-500 text-xs border-t">
            Built for Geotechnical Lab Testing | Based on ASTM D6913 Method A
        </div>
    </div>

    <!-- D1557 SECTION (NEW) -->
    <!-- D4318 SECTION (ATTERBERG LIMITS) -->
    <div id="sectionD4318" class="hidden max-w-6xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden border border-gray-200">
        
        <!-- Header -->
        <div class="bg-teal-800 text-white p-4">
            <h1 class="text-2xl font-bold text-center">Ø­Ø¯ÙˆØ¯ Ø£ØªØ±Ø¨Ø±Ø¬ â€” ASTM D4318</h1>
            <p class="text-center text-gray-200 text-sm mt-1">Standard Test Methods for Liquid Limit, Plastic Limit, and Plasticity Index of Soils</p>
        </div>

        <div class="p-6">
            <!-- General Settings -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠÙ†Ø© (Sample ID)</label>
                    <input type="text" id="d4318_sampleId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ® (Date)</label>
                    <input type="date" id="d4318_testDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© (Method)</label>
                    <select id="d4318_method" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="A">Method A â€“ Multipoint (Standard)</option>
                        <option value="B">Method B â€“ One-Point</option>
                    </select>
                </div>
            </div>

            <!-- Liquid Limit Section -->
            <div class="mb-8">
                <div class="bg-blue-50 border-r-4 border-blue-500 p-2 mb-3">
                    <h3 class="font-bold text-blue-900">Liquid Limit â€“ Casagrande (Method A â€“ Multipoint)</h3>
                    <p class="text-xs text-blue-700">Ø­Ø¯ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© - Ø·Ø±ÙŠÙ‚Ø© ÙƒØ§Ø³Ø§ØºØ±Ø§Ù†Ø¯ÙŠ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full lab-table min-w-[700px]">
                        <thead>
                            <tr>
                                <th class="w-16">#</th>
                                <th>No. of Blows (N)<br><span class="text-xs font-normal">Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø±Ø¨Ø§Øª</span></th>
                                <th>Tare WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th>Tare + Wet WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø±Ø·Ø¨ + Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th>Tare + Dry WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø¬Ø§Ù + Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th class="bg-yellow-100">Water WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„Ù…Ø§Ø¡</span></th>
                                <th class="bg-yellow-100">Dry Soil WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø¬Ø§ÙØ©</span></th>
                                <th class="bg-green-100">Moisture Content w%<br><span class="text-xs font-normal">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨ÙŠ</span></th>
                            </tr>
                        </thead>
                        <tbody id="d4318_llBody">
                            <!-- JS Generated Rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Plastic Limit Section -->
            <div class="mb-8">
                <div class="bg-purple-50 border-r-4 border-purple-500 p-2 mb-3">
                    <h3 class="font-bold text-purple-900">Plastic Limit â€“ Rolling 3.2 mm Threads</h3>
                    <p class="text-xs text-purple-700">Ø­Ø¯ Ø§Ù„Ù„Ø¯ÙˆÙ†Ø© - Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø±Ù… Ù„Ø®ÙŠÙˆØ· 3.2 Ù…Ù…</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full lab-table min-w-[700px]">
                        <thead>
                            <tr>
                                <th class="w-24">Roll No.</th>
                                <th>Tare WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th>Tare + Wet WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø±Ø·Ø¨ + Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th>Tare + Dry WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø¬Ø§Ù + Ø§Ù„Ø¹Ù„Ø¨Ø©</span></th>
                                <th class="bg-yellow-100">Water WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„Ù…Ø§Ø¡</span></th>
                                <th class="bg-yellow-100">Dry Soil WT (g)<br><span class="text-xs font-normal">ÙˆØ²Ù† Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ø¬Ø§ÙØ©</span></th>
                                <th class="bg-green-100">Moisture Content w%<br><span class="text-xs font-normal">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨ÙŠ</span></th>
                            </tr>
                        </thead>
                        <tbody id="d4318_plBody">
                            <!-- JS Generated Rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex flex-wrap gap-4 border-t pt-6 justify-center md:justify-start">
                <button onclick="calculateD4318()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-8 rounded shadow flex items-center">
                    <span class="ml-2">ğŸ§®</span> Ø§Ø­Ø³Ø¨ LL, PL, PI
                </button>
                <button onclick="resetD4318()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow flex items-center">
                    <span class="ml-2">ğŸ”„</span> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† (Reset)
                </button>
                <button onclick="loadD4318Example()" class="bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-2 px-6 rounded shadow border border-orange-300 flex items-center">
                    <span class="ml-2">ğŸ“</span> ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„ (Demo)
                </button>
            </div>

            <!-- Results Section -->
            <div id="d4318_results" class="hidden mt-8">
                <h3 class="font-bold text-gray-800 border-b pb-2 mb-4">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Final Results)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- LL Card -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center shadow-sm">
                        <div class="text-blue-800 font-bold text-lg mb-1">Liquid Limit (LL)</div>
                        <div class="text-sm text-blue-600 mb-2">Ø­Ø¯ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©</div>
                        <div class="text-4xl font-bold text-blue-900"><span id="d4318_LL_val">-</span> <span class="text-sm font-normal">%</span></div>
                    </div>
                    <!-- PL Card -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center shadow-sm">
                        <div class="text-purple-800 font-bold text-lg mb-1">Plastic Limit (PL)</div>
                        <div class="text-sm text-purple-600 mb-2">Ø­Ø¯ Ø§Ù„Ù„Ø¯ÙˆÙ†Ø©</div>
                        <div class="text-4xl font-bold text-purple-900"><span id="d4318_PL_val">-</span> <span class="text-sm font-normal">%</span></div>
                    </div>
                    <!-- PI Card -->
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center shadow-sm">
                        <div class="text-orange-800 font-bold text-lg mb-1">Plasticity Index (PI)</div>
                        <div class="text-sm text-orange-600 mb-2">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù„Ø¯ÙˆÙ†Ø©</div>
                        <div class="text-4xl font-bold text-orange-900"><span id="d4318_PI_val">-</span> <span class="text-sm font-normal">%</span></div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div id="d4318_chartWrap" class="hidden mt-8 bg-white p-4 border rounded-lg shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4 text-center">Flow Curve â€“ Liquid Limit (Casagrande Method)</h3>
                <p class="text-center text-xs text-gray-500 mb-2">Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø¶Ø±Ø¨Ø§Øª (N) ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨ÙŠ (w%)</p>
                <div class="relative h-96 w-full">
                    <canvas id="d4318_chart"></canvas>
                </div>
            </div>

        </div>
        <div class="bg-gray-100 p-4 text-center text-gray-500 text-xs border-t">
            ASTM D4318 | Method A (Multipoint)
        </div>
    </div>

    <div id="d1557Section" class="hidden max-w-6xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden border border-gray-200">
        
        <!-- Header -->
        <div class="bg-gray-900 text-white p-4">
            <h1 class="text-2xl font-bold text-center">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ù…Ùƒ Ø§Ù„Ù…Ø¹Ø¯Ù„ â€” ASTM D1557</h1>
            <p class="text-center text-gray-400 text-sm mt-1">Laboratory Compaction Characteristics of Soil Using Modified Effort</p>
        </div>

        <div class="p-6">
            
            <!-- Settings Bar -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 bg-gray-50 p-4 rounded-lg border border-gray-200">
                
                <!-- Unit Selection -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø§Øª (Units)</h3>
                    <div class="flex flex-col space-y-1">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="p_unit" value="gcm" class="form-radio text-indigo-600" checked onchange="updateProctorLabels()">
                            <span class="mr-2">g/cmÂ³ (Density)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="p_unit" value="kgm" class="form-radio text-indigo-600" onchange="updateProctorLabels()">
                            <span class="mr-2">kg/mÂ³ (Density)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="p_unit" value="knm" class="form-radio text-indigo-600" onchange="updateProctorLabels()">
                            <span class="mr-2">kN/mÂ³ (Unit Weight)</span>
                        </label>
                    </div>
                </div>

                <!-- Mold Info -->
                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ÙˆØ²Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ (Mold Mass)</label>
                        <div class="relative mt-1">
                            <input type="number" id="p_moldMass" class="block w-full border-gray-300 rounded-md border p-2 pl-8" placeholder="e.g. 2000">
                            <span class="absolute left-2 top-2 text-gray-500 text-sm">g</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ø­Ø¬Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ (Mold Volume)</label>
                        <div class="flex mt-1">
                            <input type="number" id="p_moldVol" class="block w-full border-gray-300 rounded-r-md border border-l-0 p-2" placeholder="e.g. 944">
                            <select id="p_moldVolUnit" class="border-gray-300 border p-2 bg-gray-50 rounded-l-md text-sm">
                                <option value="cm3">cmÂ³</option>
                                <option value="m3">mÂ³</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Method)</label>
                        <select class="mt-1 block w-full border-gray-300 rounded-md border p-2">
                            <option>Method A</option>
                            <option>Method B</option>
                            <option>Method C</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gs (Specific Gravity)</label>
                            <input type="number" id="p_gs" class="mt-1 block w-full border-gray-300 rounded-md border p-2" value="2.65" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" title="Percent Oversize (PC)">Oversize % (PC)</label>
                            <input type="number" id="p_pc" class="mt-1 block w-full border-gray-300 rounded-md border p-2" placeholder="0" step="0.1" onchange="toggleOversizeInputs()">
                        </div>
                    </div>
                </div>

                <!-- D4718 Correction Inputs (Hidden by default) -->
                <div id="oversizeSection" class="hidden lg:col-span-3 bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-[-1rem]">
                    <h4 class="font-bold text-yellow-800 text-sm mb-2">Ø¨ÙŠØ§Ù†Ø§Øª ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø¨ÙŠØ¨Ø§Øª Ø§Ù„Ø®Ø´Ù†Ø© (ASTM D4718 Oversize Correction)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-yellow-900">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù†ÙˆØ¹ÙŠ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠ Ù„Ù„Ø®Ø´Ù† ($G_{sb}$)</label>
                            <input type="number" id="p_gs_ov" class="mt-1 block w-full border-yellow-300 rounded-md border p-2 bg-white" placeholder="e.g. 2.60" step="0.01">
                            <p class="text-xs text-yellow-700 mt-1">Bulk Specific Gravity of Oversize</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-yellow-900">Ù…Ø­ØªÙˆÙ‰ Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ø®Ø´Ù† ($w_{ov}$)</label>
                            <div class="relative mt-1">
                                <input type="number" id="p_w_ov" class="mt-1 block w-full border-yellow-300 rounded-md border p-2 bg-white pl-8" placeholder="e.g. 1.0" step="0.1">
                                <span class="absolute left-2 top-2 text-yellow-600 text-sm">%</span>
                            </div>
                            <p class="text-xs text-yellow-700 mt-1">Water Content of Oversize</p>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="proctorMessage" class="hidden mb-4 p-4 rounded-md bg-yellow-50 text-yellow-800 border border-yellow-200"></div>

            <!-- Main Data Table -->
            <div class="overflow-x-auto">
                <table class="w-full lab-table min-w-[600px]">
                    <thead>
                        <tr>
                            <th class="w-1/6 bg-gray-100">Ø§Ù„Ø¨ÙŠØ§Ù† (Description)</th>
                            <th class="w-1/6">Point 1</th>
                            <th class="w-1/6">Point 2</th>
                            <th class="w-1/6">Point 3</th>
                            <th class="w-1/6">Point 4</th>
                            <th class="w-1/6">Point 5</th>
                        </tr>
                    </thead>
                    <tbody id="proctorTableBody">
                        <!-- Water Content Section -->
                        <tr><td colspan="6" class="bg-blue-50 text-blue-800 font-bold text-right px-2 py-1">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (Water Content)</td></tr>
                        <tr>
                            <td class="text-right pr-2">ÙˆØ²Ù† Ø§Ù„Ø¹Ù„Ø¨Ø© + ØªØ±Ø¨Ø© Ø±Ø·Ø¨Ø© (g)<br><span class="text-xs text-gray-500">Wet Soil + Tare</span></td>
                            <td><input type="number" class="lab-input p-wet" data-idx="1"></td>
                            <td><input type="number" class="lab-input p-wet" data-idx="2"></td>
                            <td><input type="number" class="lab-input p-wet" data-idx="3"></td>
                            <td><input type="number" class="lab-input p-wet" data-idx="4"></td>
                            <td><input type="number" class="lab-input p-wet" data-idx="5"></td>
                        </tr>
                        <tr>
                            <td class="text-right pr-2">ÙˆØ²Ù† Ø§Ù„Ø¹Ù„Ø¨Ø© + ØªØ±Ø¨Ø© Ø¬Ø§ÙØ© (g)<br><span class="text-xs text-gray-500">Dry Soil + Tare</span></td>
                            <td><input type="number" class="lab-input p-dry" data-idx="1"></td>
                            <td><input type="number" class="lab-input p-dry" data-idx="2"></td>
                            <td><input type="number" class="lab-input p-dry" data-idx="3"></td>
                            <td><input type="number" class="lab-input p-dry" data-idx="4"></td>
                            <td><input type="number" class="lab-input p-dry" data-idx="5"></td>
                        </tr>
                        <tr>
                            <td class="text-right pr-2">ÙˆØ²Ù† Ø§Ù„Ø¹Ù„Ø¨Ø© (g)<br><span class="text-xs text-gray-500">Tare Mass</span></td>
                            <td><input type="number" class="lab-input p-tare" data-idx="1"></td>
                            <td><input type="number" class="lab-input p-tare" data-idx="2"></td>
                            <td><input type="number" class="lab-input p-tare" data-idx="3"></td>
                            <td><input type="number" class="lab-input p-tare" data-idx="4"></td>
                            <td><input type="number" class="lab-input p-tare" data-idx="5"></td>
                        </tr>
                        <tr>
                            <td class="text-right pr-2 font-bold bg-gray-50">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (%)<br><span class="text-xs text-gray-500">Water Content (w)</span></td>
                            <td class="readonly-cell font-bold text-blue-700 p-res-w" data-idx="1">-</td>
                            <td class="readonly-cell font-bold text-blue-700 p-res-w" data-idx="2">-</td>
                            <td class="readonly-cell font-bold text-blue-700 p-res-w" data-idx="3">-</td>
                            <td class="readonly-cell font-bold text-blue-700 p-res-w" data-idx="4">-</td>
                            <td class="readonly-cell font-bold text-blue-700 p-res-w" data-idx="5">-</td>
                        </tr>

                        <!-- Density Section -->
                        <tr><td colspan="6" class="bg-indigo-50 text-indigo-800 font-bold text-right px-2 py-1">Ø§Ù„ÙƒØ«Ø§ÙØ© (Density / Unit Weight)</td></tr>
                        <tr>
                            <td class="text-right pr-2">Ø§Ù„Ù‚Ø§Ù„Ø¨ + ØªØ±Ø¨Ø© Ø±Ø·Ø¨Ø© (g)<br><span class="text-xs text-gray-500">Mold + Wet Soil</span></td>
                            <td><input type="number" class="lab-input p-moldwet" data-idx="1"></td>
                            <td><input type="number" class="lab-input p-moldwet" data-idx="2"></td>
                            <td><input type="number" class="lab-input p-moldwet" data-idx="3"></td>
                            <td><input type="number" class="lab-input p-moldwet" data-idx="4"></td>
                            <td><input type="number" class="lab-input p-moldwet" data-idx="5"></td>
                        </tr>
                        <tr>
                            <td class="text-right pr-2 font-medium bg-gray-50">Ø§Ù„ÙƒØ«Ø§ÙØ© Ø§Ù„Ø±Ø·Ø¨Ø© <span class="p-unit-lbl text-xs bg-gray-200 px-1 rounded">g/cmÂ³</span><br><span class="text-xs text-gray-500">Moist Density</span></td>
                            <td class="readonly-cell p-res-m" data-idx="1">-</td>
                            <td class="readonly-cell p-res-m" data-idx="2">-</td>
                            <td class="readonly-cell p-res-m" data-idx="3">-</td>
                            <td class="readonly-cell p-res-m" data-idx="4">-</td>
                            <td class="readonly-cell p-res-m" data-idx="5">-</td>
                        </tr>
                        <tr>
                            <td class="text-right pr-2 font-bold bg-gray-100">Ø§Ù„ÙƒØ«Ø§ÙØ© Ø§Ù„Ø¬Ø§ÙØ© <span class="p-unit-lbl text-xs bg-gray-200 px-1 rounded">g/cmÂ³</span><br><span class="text-xs text-gray-500">Dry Density</span></td>
                            <td class="readonly-cell font-bold text-indigo-800 p-res-d" data-idx="1">-</td>
                            <td class="readonly-cell font-bold text-indigo-800 p-res-d" data-idx="2">-</td>
                            <td class="readonly-cell font-bold text-indigo-800 p-res-d" data-idx="3">-</td>
                            <td class="readonly-cell font-bold text-indigo-800 p-res-d" data-idx="4">-</td>
                            <td class="readonly-cell font-bold text-indigo-800 p-res-d" data-idx="5">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Buttons -->
            <div class="mt-8 flex flex-wrap gap-4">
                <button onclick="calculateProctor()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded shadow flex items-center">
                    <span class="ml-2">âš¡</span> Ø§Ø­Ø³Ø¨ (Calculate D1557)
                </button>
                <button onclick="resetProctor()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow">
                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† (Reset)
                </button>
                <button onclick="loadProctorExample()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-2 px-6 rounded shadow border border-indigo-300 flex items-center">
                    <span class="ml-2">ğŸ“</span> ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ø§Ù„ (Demo)
                </button>
            </div>

            <!-- Proctor Results -->
            <div id="proctorResults" class="hidden mt-8">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg text-center">
                        <h4 class="text-gray-600 font-bold mb-1">Ø£Ù‚ØµÙ‰ ÙƒØ«Ø§ÙØ© Ø¬Ø§ÙØ© (MDD)</h4>
                        <div class="text-3xl font-bold text-indigo-900 ltr" id="res_mdd">-</div>
                        <div class="text-sm text-gray-500 p-unit-lbl">g/cmÂ³</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                        <h4 class="text-gray-600 font-bold mb-1">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨ÙŠ Ø§Ù„Ø£Ù…Ø«Ù„ (OMC)</h4>
                        <div class="text-3xl font-bold text-blue-900 ltr" id="res_omc">-</div>
                        <div class="text-sm text-gray-500">%</div>
                    </div>
                </div>

                <!-- D4718 Correction Results -->
                <div id="correctedResults" class="hidden mb-6 bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                    <h4 class="font-bold text-yellow-800 border-b border-yellow-200 pb-2 mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØµØ­Ø­Ø© (Corrected Results - ASTM D4718)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                        <div>
                            <h5 class="text-gray-600 font-bold text-sm">Corrected MDD</h5>
                            <div class="text-2xl font-bold text-yellow-900 ltr" id="res_corr_mdd">-</div>
                            <div class="text-xs text-gray-500 p-unit-lbl">g/cmÂ³</div>
                        </div>
                        <div>
                            <h5 class="text-gray-600 font-bold text-sm">Corrected OMC</h5>
                            <div class="text-2xl font-bold text-yellow-900 ltr" id="res_corr_omc">-</div>
                            <div class="text-xs text-gray-500">%</div>
                        </div>
                    </div>
                </div>

                <!-- Proctor Chart -->
                <div class="bg-white p-4 border rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø¯Ù…Ùƒ (Compaction Curve)</h3>
                    <div class="relative h-96 w-full">
                        <canvas id="proctorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-gray-100 p-4 text-center text-gray-500 text-xs border-t">
            ASTM D1557 | D4718 (Oversize Check Only)
        </div>
    </div>

    <script>
        // --- SHARED UTILS ---
        
        // --- 1. D6913 CONFIG & LOGIC ---
        
        const allSieves = [
            { name: "3 in", size: 75.0 },
            { name: "2 in", size: 50.0 },
            { name: "1.5 in", size: 37.5 },
            { name: "1 in", size: 25.0 },
            { name: "3/4 in", size: 19.0 },
            { name: "3/8 in", size: 9.5 },
            { name: "No.4", size: 4.75 },
            { name: "No.10", size: 2.00 },
            { name: "No.20", size: 0.85 },
            { name: "No.40", size: 0.425 },
            { name: "No.60", size: 0.25 },
            { name: "No.100", size: 0.15 },
            { name: "No.140", size: 0.106 },
            { name: "No.200", size: 0.075 },
            { name: "Pan", size: 0 }
        ];

        let chartInstance = null;
        let proctorChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            toggleOversizeInputs();
            renderTables();
            initChart();
            initProctorChart(); // Initialize empty chart
            initD4318Tables(); // Init Atterberg tables
        });

        // --- TABS LOGIC ---
        function switchTab(tab) {
            const d6913Sec = document.getElementById('d6913Section');
            const d1557Sec = document.getElementById('d1557Section');
            const d4318Sec = document.getElementById('sectionD4318');
            
            const tab6913 = document.getElementById('tab-d6913');
            const tab1557 = document.getElementById('tab-d1557');
            const tab4318 = document.getElementById('tab-d4318');

            // Hide all
            d6913Sec.classList.add('hidden');
            d1557Sec.classList.add('hidden');
            d4318Sec.classList.add('hidden');

            // Reset tabs
            [tab6913, tab1557, tab4318].forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('tab-inactive');
            });

            // Activate specific
            if (tab === 'd6913') {
                d6913Sec.classList.remove('hidden');
                tab6913.classList.add('tab-active');
                tab6913.classList.remove('tab-inactive');
            } else if (tab === 'd1557') {
                d1557Sec.classList.remove('hidden');
                tab1557.classList.add('tab-active');
                tab1557.classList.remove('tab-inactive');
            } else if (tab === 'd4318') {
                d4318Sec.classList.remove('hidden');
                tab4318.classList.add('tab-active');
                tab4318.classList.remove('tab-inactive');
            }
        }

        // --- D6913 LOGIC ---

        function toggleMethod() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const compDiv = document.getElementById('compositeInputs');
            const singDiv = document.getElementById('singleInputs');
            const resCscf = document.getElementById('res_cscf_box');

            if (method === 'composite') {
                compDiv.classList.remove('hidden');
                singDiv.classList.add('hidden');
                resCscf.classList.remove('hidden');
                renderTables();
            } else {
                compDiv.classList.add('hidden');
                singDiv.classList.remove('hidden');
                resCscf.classList.add('hidden');
            }
            document.getElementById('messageArea').classList.add('hidden');
        }

        function handleSeparationChange() {
            document.querySelectorAll('#compositeInputs input[type="number"]').forEach(i => i.value = '');
            document.querySelectorAll('#compositeInputs .readonly-cell').forEach(c => {
                 if(c.classList.contains('font-mono')) c.innerText = '-';
            });
            renderTables();
        }

        function updateLabels() {
            const unit = document.getElementById('massUnit').value;
            document.querySelectorAll('.unit-label').forEach(el => el.textContent = unit);
        }

        function renderTables() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const sepSize = parseFloat(document.getElementById('separatingSieve').value);

            const coarseTbody = document.getElementById('coarseTableBody');
            coarseTbody.innerHTML = '';
            
            const coarseSet = allSieves.filter(s => s.size >= sepSize);
            
            coarseSet.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="bg-gray-50 font-medium">${s.name}</td>
                    <td class="readonly-cell text-sm">${s.size}</td>
                    <td><input type="number" step="0.01" class="lab-input coarse-input" data-size="${s.size}" placeholder="0.00"></td>
                    <td class="readonly-cell font-mono font-bold text-blue-800 coarse-res">-</td>
                `;
                coarseTbody.appendChild(tr);
            });

            const fineTbody = document.getElementById('fineTableBody');
            fineTbody.innerHTML = '';

            const fineSet = allSieves.filter(s => s.size <= sepSize);

            fineSet.forEach((s, idx) => {
                const tr = document.createElement('tr');
                const isPan = s.size === 0;
                
                tr.innerHTML = `
                    <td class="bg-gray-50 font-medium">${s.name}</td>
                    <td class="readonly-cell text-sm">${isPan ? '-' : s.size}</td>
                    <td><input type="number" step="0.01" class="lab-input fine-input" data-size="${s.size}" placeholder="0.00"></td>
                    <td class="readonly-cell font-mono font-bold text-blue-800 fine-res">-</td>
                `;
                fineTbody.appendChild(tr);
            });

            const singleTbody = document.getElementById('singleTableBody');
            if (singleTbody.children.length === 0) {
                singleTbody.innerHTML = '';
                allSieves.forEach(s => {
                    const tr = document.createElement('tr');
                    const isPan = s.size === 0;
                    tr.innerHTML = `
                        <td class="bg-gray-50 font-medium">${s.name}</td>
                        <td class="readonly-cell text-sm">${isPan ? '-' : s.size}</td>
                        <td><input type="number" step="0.01" class="lab-input single-input" data-size="${s.size}" placeholder="0.00"></td>
                        <td class="readonly-cell font-mono font-bold text-blue-800 single-res">-</td>
                    `;
                    singleTbody.appendChild(tr);
                });
            }
        }

        function calculate() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            messageArea.classList.add('hidden');
            const sepSize = parseFloat(document.getElementById('separatingSieve').value);

            try {
                let plotData = [];
                let finalS_Md = 0;
                let cscf = 100.0;

                if (method === 'composite') {
                    const CP_Md = parseFloat(document.getElementById('cp_md').value) || 0;
                    const FP_Mm = parseFloat(document.getElementById('fp_mm').value) || 0;
                    const wfp = parseFloat(document.getElementById('wfp').value) || 0;
                    const SubS_Md = parseFloat(document.getElementById('subs_md').value) || 0;

                    if (SubS_Md <= 0) throw new Error("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† Ø¹ÙŠÙ†Ø© Ø§Ù„Ù†Ø§Ø¹Ù… Ø§Ù„Ø¬Ø§ÙØ© (SubS,Md)");
                    if (FP_Mm <= 0 && wfp > 0) throw new Error("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† Ø§Ù„Ù†Ø§Ø¹Ù… Ø§Ù„Ø±Ø·Ø¨");

                    const FP_Md = FP_Mm / (1 + (wfp / 100));
                    const S_Md = CP_Md + FP_Md;
                    finalS_Md = S_Md;

                    document.getElementById('calc_fp_md').innerText = FP_Md.toFixed(2);
                    document.getElementById('calc_s_md').innerText = S_Md.toFixed(2);
                    document.getElementById('res_s_md').innerText = S_Md.toFixed(1);

                    const coarseInputs = document.querySelectorAll('.coarse-input');
                    const coarseResults = document.querySelectorAll('.coarse-res');
                    
                    let CP_PP_Last = 100.0;
                    
                    coarseInputs.forEach((input, index) => {
                        const val = parseFloat(input.value) || 0;
                        const size = parseFloat(input.dataset.size);
                        
                        let pp = 100 * (1 - (val / S_Md));
                        if (val === 0 && index === 0) pp = 100; 
                        
                        pp = Math.max(0, Math.min(100, pp));
                        coarseResults[index].innerText = Math.round(pp); 
                        plotData.push({ x: size, y: Math.round(pp) });

                        if (Math.abs(size - sepSize) < 0.001) {
                            CP_PP_Last = pp; 
                        }
                    });

                    cscf = CP_PP_Last;
                    document.getElementById('res_cscf').innerText = cscf.toFixed(1);

                    const fineInputs = document.querySelectorAll('.fine-input');
                    const fineResults = document.querySelectorAll('.fine-res');

                    fineInputs.forEach((input, index) => {
                        const val = parseFloat(input.value) || 0;
                        const size = parseFloat(input.dataset.size);
                        const isPan = size === 0;

                        if (isPan) {
                            const diff = Math.abs(val - SubS_Md);
                            const percentDiff = (diff / SubS_Md) * 100;
                            fineResults[index].innerText = "-";
                            if (percentDiff > 1.0) {
                                messageArea.innerHTML += `<div class="text-red-600 font-bold">â€¢ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ ÙÙŠ Ø§Ù„Ù€ Pan ÙŠØ®ØªÙ„Ù Ø¹Ù† SubS,Md Ø¨Ø£ÙƒØ«Ø± Ù…Ù† 1% (${percentDiff.toFixed(1)}%). ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
                                messageArea.classList.remove('hidden');
                            }
                        } else {
                            let fpp = 1 - (val / SubS_Md);
                            let finalPP = cscf * fpp;
                            finalPP = Math.max(0, Math.min(100, finalPP));
                            
                            fineResults[index].innerText = Math.round(finalPP);

                            const existingPointIndex = plotData.findIndex(p => Math.abs(p.x - size) < 0.001);
                            if (existingPointIndex < 0) {
                                plotData.push({ x: size, y: Math.round(finalPP) });
                            }
                        }
                    });

                } else {
                    const S_Md = parseFloat(document.getElementById('single_s_md').value) || 0;
                    if (S_Md <= 0) throw new Error("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø¬Ø§Ù (S,Md)");
                    finalS_Md = S_Md;
                    document.getElementById('res_s_md').innerText = S_Md.toFixed(1);

                    const inputs = document.querySelectorAll('.single-input');
                    const results = document.querySelectorAll('.single-res');

                    inputs.forEach((input, index) => {
                        const val = parseFloat(input.value) || 0;
                        const size = parseFloat(input.dataset.size);
                        const isPan = size === 0;

                        if (isPan) {
                             const diff = Math.abs(val - S_Md);
                             if (diff / S_Md > 0.01) {
                                messageArea.innerHTML += `<div class="text-red-600 font-bold">â€¢ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ ÙÙŠ Ø§Ù„Ù€ Pan ÙŠØ®ØªÙ„Ù Ø¹Ù† Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ.</div>`;
                                messageArea.classList.remove('hidden');
                             }
                             results[index].innerText = "-";
                        } else {
                            let pp = 100 * (1 - (val / S_Md));
                            pp = Math.max(0, Math.min(100, pp));
                            results[index].innerText = Math.round(pp);
                            plotData.push({ x: size, y: Math.round(pp) });
                        }
                    });
                }

                document.getElementById('resultsSummary').classList.remove('hidden');
                updateChart(plotData);
                calculateStats(plotData);

            } catch (e) {
                messageArea.innerHTML = `<div class="text-red-600 font-bold">Ø®Ø·Ø£: ${e.message}</div>`;
                messageArea.classList.remove('hidden');
            }
        }

        function initChart() {
            const ctx = document.getElementById('gradationChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '% Ø§Ù„Ù…Ø§Ø± (Passing)',
                        data: [],
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgb(30, 64, 175)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Particle Size (mm)' },
                            min: 0.01,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return [0.075, 0.425, 2.0, 4.75, 19, 75].includes(value) ? value : '';
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Percent Passing (%)' }
                        }
                    },
                    plugins: { tooltip: { callbacks: { label: c => `Size: ${c.parsed.x} mm, Passing: ${c.parsed.y}%` } } }
                }
            });
        }

        function updateChart(data) {
            const cleanData = data.filter(d => d.x > 0);
            cleanData.sort((a, b) => b.x - a.x);
            chartInstance.data.datasets[0].data = cleanData;
            chartInstance.update();
        }

        function calculateStats(data) {
            const sorted = [...data].sort((a, b) => a.x - b.x); 
            function getD(percent) {
                for (let i = 0; i < sorted.length - 1; i++) {
                    const p1 = sorted[i];
                    const p2 = sorted[i+1];
                    if ((p1.y <= percent && p2.y >= percent) || (p1.y >= percent && p2.y <= percent)) {
                        const logD1 = Math.log10(p1.x);
                        const logD2 = Math.log10(p2.x);
                        const fraction = (percent - p1.y) / (p2.y - p1.y);
                        return Math.pow(10, logD1 + fraction * (logD2 - logD1));
                    }
                }
                return null;
            }
            const d10 = getD(10);
            document.getElementById('res_d10').innerText = d10 ? d10.toFixed(3) : "-";

            function getPercent(size) {
                 for (let i = 0; i < sorted.length - 1; i++) {
                    const p1 = sorted[i]; 
                    const p2 = sorted[i+1];
                    if (size >= p1.x && size <= p2.x) {
                        const logD1 = Math.log10(p1.x);
                        const logD2 = Math.log10(p2.x);
                        const logSize = Math.log10(size);
                        return p1.y + (logSize - logD1)/(logD2 - logD1) * (p2.y - p1.y);
                    }
                }
                if (size > sorted[sorted.length-1].x) return 100;
                if (size < sorted[0].x) return 0;
                return 0;
            }
            
            let p4 = data.find(p => Math.abs(p.x - 4.75) < 0.01)?.y;
            let p200 = data.find(p => Math.abs(p.x - 0.075) < 0.001)?.y;
            if (p4 === undefined) p4 = getPercent(4.75);
            if (p200 === undefined) p200 = getPercent(0.075);

            document.getElementById('res_comp').innerText = `G:${(100-p4).toFixed(0)}% S:${(p4-p200).toFixed(0)}% F:${p200.toFixed(0)}%`;
        }

        function resetForm() {
            document.getElementById('d6913Section').querySelectorAll('input').forEach(i => {
                if(i.type !== 'radio' && i.type !== 'date') i.value = '';
            });
            document.getElementById('d6913Section').querySelectorAll('.readonly-cell').forEach(c => {
                if(c.classList.contains('font-mono')) c.innerText = '-';
            });
            chartInstance.data.datasets[0].data = [];
            chartInstance.update();
            document.getElementById('resultsSummary').classList.add('hidden');
            document.getElementById('messageArea').classList.add('hidden');
        }

        function loadExampleData() {
            document.querySelector('input[name="method"][value="composite"]').click();
            document.getElementById('separatingSieve').value = "4.75";
            handleSeparationChange();

            document.getElementById('cp_md').value = "500.0";
            document.getElementById('fp_mm').value = "3150.0"; 
            document.getElementById('wfp').value = "5.0"; 
            document.getElementById('subs_md').value = "200.0"; 

            const findInput = (cls, size) => {
                const inputs = Array.from(document.querySelectorAll('.' + cls));
                return inputs.find(i => Math.abs(parseFloat(i.dataset.size) - size) < 0.001);
            };

            findInput('coarse-input', 9.5).value = 200; 
            findInput('coarse-input', 4.75).value = 500; 
            findInput('fine-input', 4.75).value = 0; 
            findInput('fine-input', 2.00).value = 20; 
            findInput('fine-input', 0.425).value = 100; 
            findInput('fine-input', 0.075).value = 180; 
            const fineInputs = document.querySelectorAll('.fine-input');
            fineInputs[fineInputs.length - 1].value = 200; 
            calculate();
        }


        // --- 2. D1557 PROCTOR LOGIC ---

        function toggleOversizeInputs() {
            const pc = parseFloat(document.getElementById('p_pc').value) || 0;
            const ovSec = document.getElementById('oversizeSection');
            if (pc > 0) {
                ovSec.classList.remove('hidden');
            } else {
                ovSec.classList.add('hidden');
            }
        }

        function updateProctorLabels() {
            const unitSystem = document.querySelector('input[name="p_unit"]:checked').value;
            let lbl = 'g/cmÂ³';
            if (unitSystem === 'kgm') lbl = 'kg/mÂ³';
            if (unitSystem === 'knm') lbl = 'kN/mÂ³';

            document.querySelectorAll('.p-unit-lbl').forEach(el => el.innerText = lbl);
            
            // Re-render chart if data exists? 
            // Better to let user click calculate again, or trigger calc if inputs valid.
        }

        function resetProctor() {
            document.getElementById('d1557Section').querySelectorAll('input[type="number"]').forEach(i => {
               if(i.id !== 'p_gs') i.value = ''; // keep Gs
            });
            document.getElementById('d1557Section').querySelectorAll('.readonly-cell').forEach(c => c.innerText = '-');
            document.getElementById('res_mdd').innerText = '-';
            document.getElementById('res_omc').innerText = '-';
            document.getElementById('proctorResults').classList.add('hidden');
            document.getElementById('proctorMessage').classList.add('hidden');
            document.getElementById('oversizeSection').classList.add('hidden');
            document.getElementById('correctedResults').classList.add('hidden');
            
            if(proctorChartInstance) {
                proctorChartInstance.data.datasets[0].data = [];
                proctorChartInstance.data.datasets[1].data = [];
                proctorChartInstance.data.datasets[2].data = [];
                proctorChartInstance.update();
            }
        }

        function calculateProctor() {
            const msgBox = document.getElementById('proctorMessage');
            msgBox.innerHTML = '';
            msgBox.classList.add('hidden');
            
            const moldMass = parseFloat(document.getElementById('p_moldMass').value);
            const moldVol = parseFloat(document.getElementById('p_moldVol').value);
            const moldVolUnit = document.getElementById('p_moldVolUnit').value;
            const unitSystem = document.querySelector('input[name="p_unit"]:checked').value;
            const Gs = parseFloat(document.getElementById('p_gs').value) || 2.65;
            const PC = parseFloat(document.getElementById('p_pc').value) || 0;
            
            // Correction inputs
            const Gs_ov = parseFloat(document.getElementById('p_gs_ov').value);
            const w_ov = parseFloat(document.getElementById('p_w_ov').value);

            if (!moldMass || !moldVol) {
                msgBox.innerText = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ÙˆØ­Ø¬Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨.";
                msgBox.classList.remove('hidden');
                return;
            }

            // Calc K factor for Moists Density (Target g/cm3 base)
            // if we calc everything in g/cm3 first, then convert for display.
            // MoldVol in cm3 -> K=1. MoldVol in m3 -> K=1/1000000? No.
            // Let's standardise Volume to cm3 for internal calc.
            let V_cm3 = moldVol;
            if (moldVolUnit === 'm3') V_cm3 = moldVol * 1e6;

            let points = [];
            let correctedPoints = [];
            let maxDry = 0;
            let omc = 0;

            // Density of water for correction formula based on unit system
            let rho_w_corr = 1.0;
            if (unitSystem === 'kgm') rho_w_corr = 1000.0;
            if (unitSystem === 'knm') rho_w_corr = 9.8066;

            for (let i = 1; i <= 5; i++) {
                const wetTare = parseFloat(document.querySelector(`.p-wet[data-idx="${i}"]`).value);
                const dryTare = parseFloat(document.querySelector(`.p-dry[data-idx="${i}"]`).value);
                const tare = parseFloat(document.querySelector(`.p-tare[data-idx="${i}"]`).value);
                const moldWet = parseFloat(document.querySelector(`.p-moldwet[data-idx="${i}"]`).value);

                const resW = document.querySelector(`.p-res-w[data-idx="${i}"]`);
                const resM = document.querySelector(`.p-res-m[data-idx="${i}"]`);
                const resD = document.querySelector(`.p-res-d[data-idx="${i}"]`);

                if (!isNaN(wetTare) && !isNaN(dryTare) && !isNaN(tare) && !isNaN(moldWet)) {
                    // Calc Water Content
                    const waterMass = wetTare - dryTare;
                    const drySoil = dryTare - tare;
                    
                    if(drySoil <= 0) {
                         resW.innerText = "Err"; continue; 
                    }
                    const w = (waterMass / drySoil) * 100;
                    resW.innerText = w.toFixed(1);

                    // Calc Moist Density (g/cm3)
                    const soilMass = moldWet - moldMass;
                    if(soilMass <= 0) {
                        resM.innerText = "Err"; continue;
                    }
                    const rho_m_gcm = soilMass / V_cm3;
                    
                    // Calc Dry Density (g/cm3)
                    const rho_d_gcm = rho_m_gcm / (1 + w/100);

                    // Conversion for Display
                    let disp_m, disp_d;
                    let val_d_plot; // Y value for chart

                    if (unitSystem === 'gcm') {
                        disp_m = rho_m_gcm.toFixed(3);
                        disp_d = rho_d_gcm.toFixed(3);
                        val_d_plot = rho_d_gcm;
                    } else if (unitSystem === 'kgm') {
                        disp_m = (rho_m_gcm * 1000).toFixed(0);
                        disp_d = (rho_d_gcm * 1000).toFixed(0);
                        val_d_plot = rho_d_gcm * 1000;
                    } else if (unitSystem === 'knm') {
                        // gamma = rho_gcm * 9.8066
                        const gam_m = rho_m_gcm * 9.8066;
                        const gam_d = rho_d_gcm * 9.8066;
                        disp_m = gam_m.toFixed(2);
                        disp_d = gam_d.toFixed(2);
                        val_d_plot = gam_d;
                    }

                    resM.innerText = disp_m;
                    resD.innerText = disp_d;

                    points.push({ x: w, y: val_d_plot, gcm: rho_d_gcm }); // store gcm for ZAV check

                    if (val_d_plot > maxDry) {
                        maxDry = val_d_plot;
                        omc = w;
                    }
                    
                    // --- D4718 Point Correction ---
                    if (PC > 0 && !isNaN(Gs_ov) && !isNaN(w_ov)) {
                        const PF = 100 - PC; // Percent Finer
                        const PC_dec = PC / 100;
                        const PF_dec = PF / 100;
                        
                        // Corrected Water Content: w_c = (w_f * P_f + w_c * P_c)
                        // All in percent for formula: w_total = (w_fine * PF + w_ov * PC) / 100
                        const w_total = (w * PF + w_ov * PC) / 100;

                        // Corrected Dry Density: rho_d_total = 100 / ( (PF / rho_d_fine) + (PC / (Gs_ov * rho_w)) )
                        // Ensure rho_d_fine matches unit of rho_w
                        const rho_d_fine = val_d_plot;
                        const term1 = PF / rho_d_fine;
                        const term2 = PC / (Gs_ov * rho_w_corr);
                        const rho_d_total = 100 / (term1 + term2);

                        correctedPoints.push({ x: w_total, y: rho_d_total });
                    }
                    // ------------------------------

                } else {
                    resW.innerText = "-";
                    resM.innerText = "-";
                    resD.innerText = "-";
                }
            }

            // Results Display
            document.getElementById('proctorResults').classList.remove('hidden');
            document.getElementById('res_mdd').innerText = maxDry ? maxDry.toFixed(unitSystem === 'kgm' ? 0 : 2) : '-';
            document.getElementById('res_omc').innerText = omc ? omc.toFixed(1) : '-';

            // Corrected Results Display
            const corrResDiv = document.getElementById('correctedResults');
            if (correctedPoints.length > 0) {
                let maxCorrDry = 0;
                let optCorrW = 0;
                correctedPoints.forEach(p => {
                    if (p.y > maxCorrDry) {
                        maxCorrDry = p.y;
                        optCorrW = p.x;
                    }
                });

                document.getElementById('res_corr_mdd').innerText = maxCorrDry.toFixed(unitSystem === 'kgm' ? 0 : 2);
                document.getElementById('res_corr_omc').innerText = optCorrW.toFixed(1);
                corrResDiv.classList.remove('hidden');
                
                if (PC > 5) {
                   msgBox.innerHTML += `<div>âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ D4718 (Oversize Correction).</div>`;
                   msgBox.classList.remove('hidden');
                }
            } else {
                corrResDiv.classList.add('hidden');
                if (PC > 5 && (isNaN(Gs_ov) || isNaN(w_ov))) {
                    msgBox.innerHTML += `<div>âš ï¸ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­ (D4718)ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ $G_{sb}$ Ùˆ $w_{ov}$ Ù„Ù„Ø®Ø´Ù†.</div>`;
                    msgBox.classList.remove('hidden');
                }
            }

            // Charting
            updateProctorChart(points, unitSystem, Gs, correctedPoints);
        }

        function initProctorChart() {
            const ctx = document.getElementById('proctorChart').getContext('2d');
            proctorChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Compaction Curve',
                            data: [],
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgb(79, 70, 229)',
                            showLine: true,
                            tension: 0.4,
                            pointRadius: 5
                        },
                        {
                            label: 'Zero Air Voids (100% Saturation)',
                            data: [],
                            borderColor: 'rgb(220, 38, 38)', // red-600
                            borderDash: [5, 5],
                            showLine: true,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Corrected Curve (ASTM D4718)',
                            data: [],
                            borderColor: 'rgb(21, 128, 61)', // green-700
                            backgroundColor: 'rgba(21, 128, 61, 0.5)',
                            showLine: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointStyle: 'triangle'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Water Content (%)' }
                        },
                        y: {
                            type: 'linear',
                            title: { display: true, text: 'Dry Density / Unit Weight' }
                        }
                    }
                }
            });
        }

        function updateProctorChart(points, unitSystem, Gs, correctedPoints = []) {
            // Sort points by water content
            points.sort((a, b) => a.x - b.x);
            proctorChartInstance.data.datasets[0].data = points;

            // Corrected Curve
            if (correctedPoints.length > 0) {
                correctedPoints.sort((a, b) => a.x - b.x);
                proctorChartInstance.data.datasets[2].data = correctedPoints;
                proctorChartInstance.data.datasets[2].hidden = false;
            } else {
                proctorChartInstance.data.datasets[2].data = [];
                proctorChartInstance.data.datasets[2].hidden = true;
            }

            // Generate ZAV Curve
            // Range of X: min w to max w + buffer
            if (points.length > 0) {
                const minW = points[0].x * 0.8;
                const maxW = points[points.length - 1].x * 1.2;
                
                let zavData = [];
                // Generate points
                for (let w = minW; w <= maxW; w += 0.5) {
                    // Formula: rho_d = (Gs * rho_w) / (1 + (w/100)*Gs/S) where S=1
                    // rho_w = 1 g/cm3 approx (or 0.998). D1557 says use 9.789 kN/m3 for water unit weight at 20C.
                    
                    // Let's use kN/m3 formula as base then convert back if needed
                    // gamma_d = Gs * gamma_w / (1 + w*Gs/100)
                    const gamma_w = 9.789; 
                    const gamma_d_zav = (Gs * gamma_w) / (1 + (w * Gs / 100));
                    
                    let yVal;
                    if (unitSystem === 'knm') {
                        yVal = gamma_d_zav;
                    } else if (unitSystem === 'gcm') {
                        // convert kn/m3 to g/cm3: / 9.8066
                        yVal = gamma_d_zav / 9.8066;
                    } else if (unitSystem === 'kgm') {
                        // convert kn/m3 to kg/m3: / 0.0098066
                        yVal = gamma_d_zav / 0.0098066;
                    }
                    
                    zavData.push({x: w, y: yVal});
                }
                proctorChartInstance.data.datasets[1].data = zavData;

                // Check for crossing (Validation)
                // If any point is ABOVE the ZAV line (for same w), it's physically impossible (S > 100%)
                let crossed = false;
                points.forEach(p => {
                    // Calc theoretical max Y at this w
                    const gamma_d_zav_at_w = (Gs * 9.789) / (1 + (p.x * Gs / 100));
                    let max_y;
                     if (unitSystem === 'knm') max_y = gamma_d_zav_at_w;
                     else if (unitSystem === 'gcm') max_y = gamma_d_zav_at_w / 9.8066;
                     else max_y = gamma_d_zav_at_w / 0.0098066;
                     
                     if (p.y > max_y + 0.01) { // tolerance
                         crossed = true;
                     }
                });
                
                const msgBox = document.getElementById('proctorMessage');
                if (crossed) {
                    msgBox.innerHTML += `<div class="mt-1">âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ‚Ø¹ ÙŠÙ…ÙŠÙ† Ø®Ø· Ø§Ù„ØªØ´Ø¨Ø¹ 100% (ZAV). ØªØ­Ù‚Ù‚ Ù…Ù† Gs Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.</div>`;
                    msgBox.classList.remove('hidden');
                }
            } else {
                 // Clean charts if no points
                 proctorChartInstance.data.datasets[1].data = [];
            }

            proctorChartInstance.update();
        }

        // --- 3. D4318 ATTERBERG LIMITS LOGIC ---
        
        let d4318ChartInstance = null;

        function initD4318Tables() {
            const llBody = document.getElementById('d4318_llBody');
            llBody.innerHTML = '';
            // Create 4 rows for LL
            for (let i = 1; i <= 4; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="bg-gray-50 text-center font-bold">${i}</td>
                    <td><input type="number" class="lab-input ll-n" oninput="calculateD4318Row('ll', ${i})" placeholder="15-35"></td>
                    <td><input type="number" step="0.01" class="lab-input ll-tare" oninput="calculateD4318Row('ll', ${i})"></td>
                    <td><input type="number" step="0.01" class="lab-input ll-wet" oninput="calculateD4318Row('ll', ${i})"></td>
                    <td><input type="number" step="0.01" class="lab-input ll-dry" oninput="calculateD4318Row('ll', ${i})"></td>
                    <td class="readonly-cell bg-yellow-50 font-mono text-xs ll-water">-</td>
                    <td class="readonly-cell bg-yellow-50 font-mono text-xs ll-drysoil">-</td>
                    <td class="readonly-cell bg-green-50 font-bold text-teal-800 ll-w">-</td>
                `;
                llBody.appendChild(tr);
            }

            const plBody = document.getElementById('d4318_plBody');
            plBody.innerHTML = '';
            // Create 2 rows for PL
            for (let i = 1; i <= 2; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="bg-gray-50 text-center font-bold">Roll ${i}</td>
                    <td><input type="number" step="0.01" class="lab-input pl-tare" oninput="calculateD4318Row('pl', ${i})"></td>
                    <td><input type="number" step="0.01" class="lab-input pl-wet" oninput="calculateD4318Row('pl', ${i})"></td>
                    <td><input type="number" step="0.01" class="lab-input pl-dry" oninput="calculateD4318Row('pl', ${i})"></td>
                    <td class="readonly-cell bg-yellow-50 font-mono text-xs pl-water">-</td>
                    <td class="readonly-cell bg-yellow-50 font-mono text-xs pl-drysoil">-</td>
                    <td class="readonly-cell bg-green-50 font-bold text-teal-800 pl-w">-</td>
                `;
                plBody.appendChild(tr);
            }
        }

        function calculateD4318Row(type, idx) {
            // Select row inputs based on type (ll or pl) and index (nth-child)
            // Note: Since we are using class names on inputs, we can find them relative to the table or by traversing
            // But to keep it simple, let's select all inputs of that class and pick the (idx-1) one.
            
            const tareInputs = document.querySelectorAll(`.${type}-tare`);
            const wetInputs = document.querySelectorAll(`.${type}-wet`);
            const dryInputs = document.querySelectorAll(`.${type}-dry`);
            
            const waterCells = document.querySelectorAll(`.${type}-water`);
            const drySoilCells = document.querySelectorAll(`.${type}-drysoil`);
            const wCells = document.querySelectorAll(`.${type}-w`);

            const i = idx - 1;
            const tare = parseFloat(tareInputs[i].value);
            const wet = parseFloat(wetInputs[i].value);
            const dry = parseFloat(dryInputs[i].value);

            if (!isNaN(tare) && !isNaN(wet) && !isNaN(dry)) {
                const water = wet - dry;
                const drySoil = dry - tare;
                
                waterCells[i].innerText = water.toFixed(2);
                drySoilCells[i].innerText = drySoil.toFixed(2);

                if (drySoil > 0) {
                    const w = (water / drySoil) * 100;
                    wCells[i].innerText = w.toFixed(2);
                } else {
                    wCells[i].innerText = "-";
                }
            } else {
                waterCells[i].innerText = "-";
                drySoilCells[i].innerText = "-";
                wCells[i].innerText = "-";
            }
        }

        function calculateD4318() {
            // 1. Gather LL Data
            const nInputs = document.querySelectorAll('.ll-n');
            const wCells = document.querySelectorAll('.ll-w');
            
            let llPoints = [];
            for(let i=0; i<nInputs.length; i++) {
                const n = parseFloat(nInputs[i].value);
                const w = parseFloat(wCells[i].innerText);
                if (!isNaN(n) && !isNaN(w) && n > 0 && w > 0) {
                    llPoints.push({ n: n, w: w, logN: Math.log10(n) });
                }
            }

            // 2. Gather PL Data
            const plWCells = document.querySelectorAll('.pl-w');
            let plValues = [];
            for(let i=0; i<plWCells.length; i++) {
                const w = parseFloat(plWCells[i].innerText);
                if (!isNaN(w) && w > 0) {
                    plValues.push(w);
                }
            }

            // Validation
            if (llPoints.length < 2) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ù‚Ø·ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø­Ø³Ø§Ø¨ Liquid Limit (LL).");
                return;
            }
            if (plValues.length === 0) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Plastic Limit (PL).");
                return;
            }

            // 3. Calc LL (Linear Regression on Semi-Log: w vs log10(N))
            // w = Slope * log10(N) + Intercept
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            const N_count = llPoints.length;
            
            llPoints.forEach(p => {
                sumX += p.logN;
                sumY += p.w;
                sumXY += (p.logN * p.w);
                sumXX += (p.logN * p.logN);
            });

            const slope = (N_count * sumXY - sumX * sumY) / (N_count * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / N_count;

            // LL is w at N=25
            const log25 = Math.log10(25);
            const LL_val = slope * log25 + intercept;

            // 4. Calc PL (Average)
            const sumPL = plValues.reduce((a, b) => a + b, 0);
            const PL_val = sumPL / plValues.length;

            // 5. Calc PI
            const PI_val = Math.max(0, LL_val - PL_val);

            // Display Results
            document.getElementById('d4318_results').classList.remove('hidden');
            document.getElementById('d4318_chartWrap').classList.remove('hidden');

            document.getElementById('d4318_LL_val').innerText = LL_val.toFixed(0); // Round to nearest whole number as per ASTM usually, or 1 decimal
            document.getElementById('d4318_PL_val').innerText = PL_val.toFixed(0);
            document.getElementById('d4318_PI_val').innerText = PI_val.toFixed(0);

            // Draw Chart
            drawD4318Chart(llPoints, slope, intercept);
        }

        function drawD4318Chart(points, slope, intercept) {
            const ctx = document.getElementById('d4318_chart').getContext('2d');
            
            // Generate Line Points (from N=10 to N=100)
            const lineData = [];
            [10, 100].forEach(n => {
                const w = slope * Math.log10(n) + intercept;
                lineData.push({ x: n, y: w });
            });

            // Map scatter points for chart.js
            const scatterData = points.map(p => ({ x: p.n, y: p.w }));

            if (d4318ChartInstance) {
                d4318ChartInstance.destroy();
            }

            d4318ChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Test Points (Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)',
                            data: scatterData,
                            backgroundColor: 'rgb(29, 78, 216)', // blue-700
                            borderColor: 'rgb(29, 78, 216)',
                            pointRadius: 6
                        },
                        {
                            label: 'Flow Line (Ø®Ø· Ø§Ù„ØªØ¯ÙÙ‚)',
                            data: lineData,
                            type: 'line',
                            borderColor: 'rgb(59, 130, 246)', // blue-500
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'LL (N=25)',
                            data: [{x: 25, y: slope * Math.log10(25) + intercept}],
                            pointRadius: 8,
                            pointStyle: 'star',
                            backgroundColor: 'red',
                            borderColor: 'red'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Number of Blows (N)' },
                            min: 10,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return [10, 20, 25, 30, 40, 50, 100].includes(value) ? value : '';
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            title: { display: true, text: 'Water Content (%)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `N: ${context.parsed.x}, w: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function resetD4318() {
            initD4318Tables();
            document.getElementById('d4318_results').classList.add('hidden');
            document.getElementById('d4318_chartWrap').classList.add('hidden');
            document.getElementById('d4318_sampleId').value = '';
            document.getElementById('d4318_testDate').value = '';
            if (d4318ChartInstance) {
                d4318ChartInstance.destroy();
                d4318ChartInstance = null;
            }
        }

        function loadD4318Example() {
            // Clear first
            resetD4318();

            // Set Meta
            document.getElementById('d4318_sampleId').value = 'EX-2023-LLPL';
            
            // Fill LL Data (Simulate High Plasticity Clay)
            // Points around N=15..35
            const llData = [
                { n: 34, tare: 20.5, wet: 35.6, dry: 30.1 }, // w approx 57%
                { n: 27, tare: 21.0, wet: 38.2, dry: 31.8 }, // w approx 59%
                { n: 19, tare: 20.2, wet: 37.5, dry: 30.8 }, // w approx 63%
            ];

            const nInputs = document.querySelectorAll('.ll-n');
            const tInputs = document.querySelectorAll('.ll-tare');
            const wInputs = document.querySelectorAll('.ll-wet');
            const dInputs = document.querySelectorAll('.ll-dry');

            llData.forEach((d, i) => {
                nInputs[i].value = d.n;
                tInputs[i].value = d.tare;
                wInputs[i].value = d.wet;
                dInputs[i].value = d.dry;
                calculateD4318Row('ll', i+1);
            });

            // Fill PL Data (w approx 25%)
            // Row 1
            const plTare = document.querySelectorAll('.pl-tare');
            const plWet = document.querySelectorAll('.pl-wet');
            const plDry = document.querySelectorAll('.pl-dry');

            // Roll 1
            plTare[0].value = 15.0;
            plWet[0].value = 22.5;
            plDry[0].value = 21.0; // water=1.5, soil=6.0, w=25%
            calculateD4318Row('pl', 1);

            // Roll 2
            plTare[1].value = 15.5;
            plWet[1].value = 23.1;
            plDry[1].value = 21.6; // water=1.5, soil=6.1, w=24.6%
            calculateD4318Row('pl', 2);

            // Trigger Calc
            calculateD4318();
        }

        function loadProctorExample() {
            resetProctor();
            
            // Set General Data
            document.getElementById('p_moldMass').value = "4178";
            document.getElementById('p_moldVol').value = "944";
            document.getElementById('p_moldVolUnit').value = "cm3";
            document.getElementById('p_gs').value = "2.70";
            document.querySelector('input[name="p_unit"][value="gcm"]').click();

            // Data Points (Targeting a typical curve)
            // Point 1: w ~ 7%
            document.querySelector('.p-wet[data-idx="1"]').value = "264.2";
            document.querySelector('.p-dry[data-idx="1"]').value = "250.0";
            document.querySelector('.p-tare[data-idx="1"]').value = "50.0";
            document.querySelector('.p-moldwet[data-idx="1"]').value = "6201";

            // Point 2: w ~ 9%
            document.querySelector('.p-wet[data-idx="2"]').value = "268.0";
            document.querySelector('.p-dry[data-idx="2"]').value = "250.0";
            document.querySelector('.p-tare[data-idx="2"]').value = "50.0";
            document.querySelector('.p-moldwet[data-idx="2"]').value = "6320";

            // Point 3: w ~ 11% (Peak)
            document.querySelector('.p-wet[data-idx="3"]').value = "272.0";
            document.querySelector('.p-dry[data-idx="3"]').value = "250.0";
            document.querySelector('.p-tare[data-idx="3"]').value = "50.0";
            document.querySelector('.p-moldwet[data-idx="3"]').value = "6380";

            // Point 4: w ~ 13%
            document.querySelector('.p-wet[data-idx="4"]').value = "276.0";
            document.querySelector('.p-dry[data-idx="4"]').value = "250.0";
            document.querySelector('.p-tare[data-idx="4"]').value = "50.0";
            document.querySelector('.p-moldwet[data-idx="4"]').value = "6367";

            // Point 5: w ~ 15%
            document.querySelector('.p-wet[data-idx="5"]').value = "280.0";
            document.querySelector('.p-dry[data-idx="5"]').value = "250.0";
            document.querySelector('.p-tare[data-idx="5"]').value = "50.0";
            document.querySelector('.p-moldwet[data-idx="5"]').value = "6330";

            // Calculate
            calculateProctor();
        }

    </script>
</body>
    </html>
